{% extends 'base.html' %}
{%  load static %}

{% block title %}
Sem B.O
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'front/home_style.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
<section class="content-page">
    {% include 'parciais/menu.html' %}
    <div class="central-container px-4 md:mt-0 mt-8 md:mx-[5rem]">
        <div class="mb-4 hidden md:block">
            <div class="welcome text-black-700 font-semibold text-3xl text-left">
                Olá, <b class="text-black-700">Sr(a) {{ user.first_name.title }}</b>
            </div>
            <div class="note text-gray-600 text-base text-left mt-1">
                {% for occupation in user.occupations.all %}
                    <b class="font-semibold">{{ occupation.name }}</b>
                {% endfor %}
            </div>
        </div>

        <form id="search-form" class="form-search w-full" method="GET" action="{% url 'search' %}">
            {% csrf_token %}
            <div class="search flex flex-row items-center gap-2 bg-transparent w-full">
                <div class="w-full">
                    <input type="text" name="q" class="block rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2 bg-[#F2F2F7] w-full" placeholder="Digite o procedimento">
                </div>
                <button type="submit" aria-label="search" class="flex items-center justify-center rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition">
                    <ion-icon name="search-outline" class="w-5 h-5 md hydrated" role="img"></ion-icon>
                </button>
            </div>
        </form>

        <div class="results none mt-4">
            <div class="search_results"></div>
        </div>

        <div class="banner flex justify-center items-start md:items-center mt-4 md:mt-6">
            <img src="{% static 'assets/abstract.jpg' %}" class="object-cover w-full md:max-h-[250px] md:max-h-none rounded-lg">
        </div>
    </div>

    {% include 'parciais/menu_inferior.html' %}
</section>

<div class="content-principal folder-modal">
    <div id="favorite-modal" class="modal hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-60 backdrop-blur-sm z-50">
        <div class="modal-content-folder bg-white w-11/12 md:w-2/3 lg:w-1/3 mx-auto rounded-2xl p-6 max-h-[80vh] overflow-auto shadow-2xl">
            <div class="sup-folder flex justify-between items-center mb-6">
                <div></div>
                <h2 class="text-xl font-bold text-gray-800 text-center">
                    <i class="fas fa-folder text-yellow-500 mr-2"></i>
                    Pastas de Favoritos
                </h2>
                <button class="close text-gray-400 hover:text-gray-600 transition-colors text-2xl leading-none" aria-label="Fechar">
                    &times;
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4 text-center">Selecione as pastas onde deseja salvar este procedimento</p>
            
            <ul class="mb-6 space-y-2">
                {% for folder in favorite_folders %}
                <li class="folder-item">
                    <label for="folder-{{ folder.id }}" class="label-folder cursor-pointer list-folders flex justify-between items-center bg-gray-50 hover:bg-gray-100 p-4 rounded-lg transition-colors border border-gray-200">
                        <span class="truncate max-w-[70%] font-medium text-gray-700">
                            <i class="fas fa-folder-open text-yellow-500 mr-2"></i>
                            {{ folder.name }}
                        </span>
                        <input type="checkbox" id="folder-{{ folder.id }}" name="folders" value="{{ folder.id }}" class="checkbox-custom w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" {% if folder.name == 'Geral' %}checked{% endif %}>
                    </label>
                </li>
                {% endfor %}
            </ul>
            
            <button id="confirm-favorite" class="bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-900 text-white w-full py-3 px-4 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                <i class="fas fa-check mr-2"></i>Confirmar
            </button>
        </div>
    </div>
    <div class="blur hidden"></div>
</div>


<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    /**
     * Home Page Search & Favorites Manager
     * Refatorado para melhor performance, manutenibilidade e prevenção de erros
     */
    $(document).ready(function () {
        // ========================================
        // CONFIGURAÇÃO E ESTADO DA APLICAÇÃO
        // ========================================
        const CONFIG = {
            INITIAL_PAGE: 2,
            FEEDBACK_DURATION: 2000,
            FEEDBACK_FADE_DURATION: 500
        };

        const STATE = {
            page: CONFIG.INITIAL_PAGE,
            loading: false,
            searchActive: false,
            currentQuery: ''
        };

        // ========================================
        // CACHE DE ELEMENTOS DOM
        // ========================================
        const ELEMENTS = {
            searchForm: $('#search-form'),
            searchResults: $('.search_results'),
            searchInput: null, // Será inicializado
            banner: $('.banner'),
            searchIcon: $('#search'),
            closeIcon: $('#close-filter'),
            modal: $('#favorite-modal'),
            blurOverlay: $('.blur'),
            confirmFavoriteButton: $('#confirm-favorite')
        };

        // Inicializa elementos que dependem de outros
        ELEMENTS.searchInput = ELEMENTS.searchForm.find('input[name="q"]');

        // ========================================
        // UTILIDADES
        // ========================================
        const Utils = {
            /**
             * Escapa HTML para prevenir XSS
             */
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            },

            /**
             * Copia texto para clipboard de forma moderna
             */
            async copyToClipboard(text) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } else {
                        // Fallback para navegadores antigos
                        const tempTextArea = $('<textarea>')
                            .val(text)
                            .css({
                                position: 'fixed',
                                left: '-9999px',
                                top: '-9999px'
                            })
                            .appendTo('body');
                        
                        tempTextArea.select();
                        const success = document.execCommand('copy');
                        tempTextArea.remove();
                        return success;
                    }
                } catch (err) {
                    console.error('Erro ao copiar:', err);
                    return false;
                }
            },

            /**
             * Debounce para otimizar eventos
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ========================================
        // FEEDBACK VISUAL
        // ========================================
        const Feedback = {
            /**
             * Mostra mensagem de feedback ao usuário
             */
            show(message, success = true) {
                // Remove feedbacks anteriores
                $('.feedback-message').remove();

                const feedback = $('<div class="feedback-message"></div>')
                    .css({
                        position: 'fixed',
                        top: '20px',
                        right: '20px',
                        backgroundColor: success ? '#10B981' : '#EF4444',
                        color: 'white',
                        padding: '12px 20px',
                        borderRadius: '8px',
                        zIndex: '9999',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                        fontWeight: '500',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    })
                    .html(`
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            ${success 
                                ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>'
                                : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>'
                            }
                        </svg>
                        <span>${Utils.escapeHtml(message)}</span>
                    `)
                    .appendTo('body')
                    .hide()
                    .fadeIn(200);

                setTimeout(() => {
                    feedback.fadeOut(CONFIG.FEEDBACK_FADE_DURATION, function() {
                        $(this).remove();
                    });
                }, CONFIG.FEEDBACK_DURATION);
            }
        };

        // ========================================
        // GERENCIAMENTO DE UI
        // ========================================
        const UI = {
            /**
             * Alterna visibilidade dos ícones de busca/fechar
             */
            toggleSearchIcons() {
                if (STATE.searchActive) {
                    ELEMENTS.searchIcon.hide();
                    ELEMENTS.closeIcon.show();
                } else {
                    ELEMENTS.searchIcon.show();
                    ELEMENTS.closeIcon.hide();
                }
            },

            /**
             * Mostra estado de loading
             */
            showLoading() {
                $('#load-more').hide();
                $('.loading').show();
            },

            /**
             * Esconde estado de loading
             */
            hideLoading() {
                $('.loading').hide();
                $('#load-more').show();
            },

            /**
             * Limpa resultados de busca
             */
            clearResults() {
                ELEMENTS.searchResults.empty();
                STATE.page = CONFIG.INITIAL_PAGE;
            },

            /**
             * Reseta estado da busca
             */
            resetSearch() {
                STATE.searchActive = false;
                this.toggleSearchIcons();
                this.clearResults();
                ELEMENTS.searchInput.val('');
                ELEMENTS.banner.removeClass('none');
                ELEMENTS.searchResults.parent().removeClass('block').addClass('none');
            },

            /**
             * Mostra modal de favoritos
             */
            showModal() {
                ELEMENTS.modal.removeClass('hidden');
                ELEMENTS.blurOverlay.show();
            },

            /**
             * Esconde modal de favoritos
             */
            hideModal() {
                ELEMENTS.modal.addClass('hidden');
                ELEMENTS.blurOverlay.hide();
            }
        };

        // ========================================
        // RENDERIZAÇÃO DE PROCEDIMENTOS
        // ========================================
        const ProcedureRenderer = {
            /**
             * Cria URL de detalhes do procedimento
             */
            createDetailUrl(procedureCode) {
                const baseUrl = "{% url 'procedure_detail' procedure_code='__PROCEDURE_CODE__' %}";
                return baseUrl.replace("__PROCEDURE_CODE__", encodeURIComponent(procedureCode));
            },

            /**
             * Cria HTML do procedimento de forma segura
             */
            create(procedure) {
                if (!procedure || !procedure.code) {
                    console.warn('Procedimento inválido:', procedure);
                    return null;
                }

                const detailUrl = this.createDetailUrl(procedure.code);
                const escapedName = Utils.escapeHtml(procedure.name || 'Sem nome');
                const escapedCode = Utils.escapeHtml(procedure.code);

                const procedureDiv = $('<div class="procedure p-4 my-2 border rounded-lg"></div>');
                
                // Title e tags
                const nameLink = $(`
                    <div class="title_tags">
                        <a class="title_procedure" href="${detailUrl}">${escapedName}</a>
                    </div>
                `);

                const records = $('<div class="records_tags mt-2 md:mt-0 flex"></div>');
                
                // Combina ocupações e registros
                const allTags = [];
                if (Array.isArray(procedure.occupations_names)) {
                    allTags.push(...procedure.occupations_names.map(o => ({ text: o, isOccupation: true })));
                }
                if (Array.isArray(procedure.records_names)) {
                    allTags.push(...procedure.records_names.map(r => ({ text: r, isOccupation: false })));
                }
                
                // Renderiza tags com limite máximo de 2
                const maxVisibleTags = 2;
                const visibleTags = allTags.slice(0, maxVisibleTags);
                const hiddenCount = allTags.length - maxVisibleTags;
                
                // Tags visíveis (com truncamento)
                visibleTags.forEach(tag => {
                    const truncated = tag.text.length > 20 ? tag.text.substring(0, 20) + '...' : tag.text;
                    const escapedText = Utils.escapeHtml(truncated);
                    const className = tag.isOccupation ? 'procedure-occupation tag-item' : 'tag-item';
                    records.append(`<a class="${className}">${escapedText}</a>`);
                });
                
                // Indicador de mais tags se houver
                if (hiddenCount > 0) {
                    records.append(`<span class="more-tags-indicator inline-flex items-center rounded-full bg-slate-100 text-slate-600 px-2 py-0.5 text-[11px] font-semibold" title="Clique no procedimento para ver todos os detalhes">+${hiddenCount}</span>`);
                }
                
                nameLink.append(records);

                // Info da direita
                const rightInfo = $('<div class="right_info"></div>');
                const codeProcedure = $(`<div class="procedure_code w-[70%] md:w-[8rem]">${escapedCode}</div>`);
                
                const favoriteIconName = procedure.favorite ? 'bookmark' : 'bookmark-outline';
                const icon = $(`
                    <ion-icon 
                        name="${favoriteIconName}" 
                        class="w-[10%] md:w-10 h-5 favorite-icon cursor-pointer text-slate-500 hover:text-cyan-600 transition-colors" 
                        data-procedure-id="${escapedCode}"
                    ></ion-icon>
                `);
                
                const help = $(`
                    <a class="help-icon w-[20%] md:w-10 md:mr-4 text-slate-500 hover:text-cyan-600 transition-colors" href="${detailUrl}">
                        <div class="help">
                            <ion-icon name="help-circle-outline" role="img" class="md hydrated"></ion-icon>
                        </div>
                    </a>
                `);

                rightInfo.append(icon, codeProcedure, help);
                procedureDiv.append(nameLink, rightInfo);

                return procedureDiv;
            },

            /**
             * Adiciona procedimento aos resultados
             */
            append(procedure) {
                const procedureElement = this.create(procedure);
                if (!procedureElement) return;

                const loadMoreButton = $('#load-more');
                if (loadMoreButton.length) {
                    procedureElement.insertBefore(loadMoreButton);
                } else {
                    ELEMENTS.searchResults.append(procedureElement);
                }
            },

            /**
             * Adiciona botão "Carregar Mais"
             */
            addLoadMoreButton() {
                const loadMoreBtn = $(`
                    <button 
                        id="load-more" 
                        class="flex items-center justify-center rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition w-full mt-4"
                    >
                        Carregar Mais
                    </button>
                `);

                const loadingDiv = $(`
                    <div 
                        class="loading flex items-center justify-center rounded-md border border-gray-300 shadow-sm sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] w-full mt-4" 
                        style="display: none;"
                    >
                        <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Carregando...
                    </div>
                `);

                ELEMENTS.searchResults.append(loadMoreBtn, loadingDiv);
            },

            /**
             * Remove botão "Carregar Mais"
             */
            removeLoadMoreButton() {
                $('#load-more, .loading').remove();
            },

            /**
             * Mostra mensagem de "não encontrado"
             */
            showNoResults() {
                const message = $(`
                    <div class="no-procedures text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="font-medium">Procedimento não encontrado</p>
                        <p class="text-sm mt-1">ou não disponível para sua ocupação</p>
                    </div>
                `);
                ELEMENTS.searchResults.append(message);
            }
        };

        // ========================================
        // AJAX & BUSCA
        // ========================================
        const Search = {
            /**
             * Carrega mais procedimentos (paginação)
             */
            loadMore(query) {
                if (STATE.loading) return;

                STATE.loading = true;
                UI.showLoading();

                $.ajax({
                    type: 'GET',
                    url: ELEMENTS.searchForm.attr('action'),
                    data: { q: query, page: STATE.page },
                    dataType: 'json',
                    success: (data) => {
                        if (data.procedures && Array.isArray(data.procedures) && data.procedures.length > 0) {
                            data.procedures.forEach(proc => ProcedureRenderer.append(proc));

                            const hasMoreResults = data.procedures[0]?.has_more_results;
                            if (!hasMoreResults) {
                                ProcedureRenderer.removeLoadMoreButton();
                            } else {
                                STATE.page++;
                            }
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('Erro ao carregar mais procedimentos:', error);
                        Feedback.show('Erro ao carregar procedimentos', false);
                    },
                    complete: () => {
                        STATE.loading = false;
                        UI.hideLoading();
                    }
                });
            },

            /**
             * Carrega procedimentos iniciais
             */
            load(query) {
                if (!query || !query.trim()) {
                    Feedback.show('Digite um termo para buscar', false);
                    return;
                }

                STATE.currentQuery = query;

                $.ajax({
                    type: 'GET',
                    url: ELEMENTS.searchForm.attr('action'),
                    data: { q: query },
                    dataType: 'json',
                    success: (data) => {
                        if (data.procedures && Array.isArray(data.procedures) && data.procedures.length > 0) {
                            data.procedures.forEach(proc => ProcedureRenderer.append(proc));

                            const hasMoreResults = data.procedures[0]?.has_more_results;
                            if (hasMoreResults) {
                                ProcedureRenderer.addLoadMoreButton();
                            }
                        } else {
                            ProcedureRenderer.showNoResults();
                        }

                        UI.toggleSearchIcons();
                        ELEMENTS.banner.addClass('none');
                        ELEMENTS.searchResults.parent().removeClass('none').addClass('block');
                    },
                    error: (xhr, status, error) => {
                        console.error('Erro na busca:', error);
                        Feedback.show('Erro ao buscar procedimentos', false);
                        ProcedureRenderer.showNoResults();
                    }
                });
            }
        };

        // ========================================
        // GERENCIAMENTO DE FAVORITOS
        // ========================================
        const Favorites = {
            currentProcedureCode: null,

            /**
             * Verifica status de favorito e atualiza modal
             */
            checkStatus(procedureCode) {
                $.ajax({
                    url: '/check_favorite/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    data: { procedure_id: procedureCode },
                    success: (data) => {
                        $('input[name="folders"]').prop('checked', false);

                        if (data.is_favorite && Array.isArray(data.favorite_folders)) {
                            data.favorite_folders.forEach(folderId => {
                                $(`input[name="folders"][value="${folderId}"]`).prop('checked', true);
                            });
                        } else {
                            // Marca pasta "Geral" por padrão
                            $('input[name="folders"][value="1"]').prop('checked', true);
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('Erro ao verificar favorito:', error);
                        Feedback.show('Erro ao verificar favorito', false);
                    }
                });
            },

            /**
             * Adiciona/remove favorito
             */
            toggle(procedureCode) {
                const selectedFolderIds = $('input[name="folders"]:checked')
                    .map(function() { return $(this).val(); })
                    .get();

                if (selectedFolderIds.length === 0) {
                    Feedback.show('Selecione pelo menos uma pasta', false);
                    return;
                }

                ELEMENTS.confirmFavoriteButton.prop('disabled', true);

                $.ajax({
                    url: '/add-remove-favorite/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    data: {
                        folders: selectedFolderIds,
                        procedure_id: procedureCode
                    },
                    success: (data) => {
                        const icon = $(`.favorite-icon[data-procedure-id="${procedureCode}"]`);
                        const newIconName = data.is_favorite ? 'bookmark' : 'bookmark-outline';
                        icon.attr('name', newIconName);

                        UI.hideModal();
                        
                        const message = data.is_favorite 
                            ? 'Procedimento favoritado!' 
                            : 'Procedimento removido dos favoritos';
                        Feedback.show(message, true);
                    },
                    error: (xhr, status, error) => {
                        console.error('Erro ao favoritar:', error);
                        Feedback.show('Erro ao favoritar procedimento', false);
                    },
                    complete: () => {
                        ELEMENTS.confirmFavoriteButton.prop('disabled', false);
                    }
                });
            },

            /**
             * Abre modal de favoritos
             */
            openModal(procedureCode) {
                if (!procedureCode) {
                    console.error('Código de procedimento inválido');
                    return;
                }

                this.currentProcedureCode = procedureCode;
                UI.showModal();
                this.checkStatus(procedureCode);
            }
        };

        // ========================================
        // EVENT LISTENERS
        // ========================================
        
        // Submissão do formulário de busca
        ELEMENTS.searchForm.on('submit', function(e) {
            e.preventDefault();
            
            STATE.searchActive = true;
            UI.clearResults();
            
            const query = ELEMENTS.searchInput.val().trim();
            if (query) {
                Search.load(query);
            }
        });

        // Botão de fechar busca
        ELEMENTS.closeIcon.on('click', () => UI.resetSearch());

        // Ícone de busca
        ELEMENTS.searchIcon.on('click', () => ELEMENTS.searchForm.submit());

        // Delegação de evento: Carregar mais procedimentos
        $(document).on('click', '#load-more', function() {
            Search.loadMore(STATE.currentQuery);
        });

        // Delegação de evento: Ícone de favorito
        $(document).on('click', '.favorite-icon', function() {
            const procedureCode = $(this).data('procedureId');
            Favorites.openModal(procedureCode);
        });

        // Delegação de evento: Copiar código do procedimento
        $(document).on('click', '.procedure_code', async function() {
            const code = $(this).text().trim();
            const success = await Utils.copyToClipboard(code);
            Feedback.show(success ? 'Código copiado!' : 'Erro ao copiar código', success);
        });

        // Fechar modal
        $('.modal .close').on('click', () => UI.hideModal());
        ELEMENTS.blurOverlay.on('click', () => UI.hideModal());

        // Confirmar favorito
        ELEMENTS.confirmFavoriteButton.on('click', function() {
            if (Favorites.currentProcedureCode) {
                Favorites.toggle(Favorites.currentProcedureCode);
            }
        });

        // Fechar modal com ESC
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && !ELEMENTS.modal.hasClass('hidden')) {
                UI.hideModal();
            }
        });

        // Inicialização
        UI.toggleSearchIcons();
    });
</script>
{% endblock %}
