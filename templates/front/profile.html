  {% extends 'base.html' %}
  {% load static %}

  {% block title %}Sem B.O{% endblock %}

  {% block head %}
    <link rel="stylesheet" href="{% static 'front/profile_style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>
  {% endblock %}

  {% block content %}
  <div class="flex flex-col items-center justify-center min-h-screen text-gray-800 pb-28 px-4 bg-gradient-to-b from-slate-50 to-white">
    <div class="w-full max-w-5xl bg-white/90 backdrop-blur rounded-2xl shadow-xl ring-1 ring-gray-100 p-6 md:p-8">
      <!-- Header -->
      <div class="flex flex-col gap-6 md:gap-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-5">
          <div class="flex items-start gap-4">
            <img src="{% static 'assets/procedure.jpg' %}" alt="Foto de perfil" class="w-16 h-16 md:w-20 md:h-20 rounded-2xl object-cover shadow-lg border border-gray-200">
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.28em] text-gray-500 mb-1">Perfil</p>
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 leading-tight truncate">{{ request.user.first_name.title }} {{ request.user.last_name.title }}</h2>
              <p class="text-sm text-gray-600 truncate">{{ request.user.email }}</p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <button onclick="toggleForm()" type="button" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-black text-white text-sm font-semibold shadow hover:bg-gray-900 transition">
              Editar perfil
            </button>
            <form action="/logout/" method="post" class="w-full sm:w-auto">
              {% csrf_token %}
              <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold border border-gray-200 hover:bg-gray-200 transition">
                Sair
              </button>
            </form>
          </div>
        </div>

        <!-- Form -->
        <div class="profile-form hidden md:max-h-none max-h-[35vh] overflow-y-auto pr-1">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-gray-500">Atualizar dados</p>
              <h3 class="text-lg font-semibold text-gray-900">Informações pessoais</h3>
            </div>
            <button onclick="toggleForm()" type="button" class="text-gray-600 hover:text-gray-900 transition">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="profile-form" action="{% url 'profile' %}" method="post" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% csrf_token %}

            <div class="space-y-1">
              <label for="id_first_name" class="block text-sm font-medium text-gray-700">Nome</label>
              <input type="text" name="first_name" id="id_first_name" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.first_name }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_last_name" class="block text-sm font-medium text-gray-700">Sobrenome</label>
              <input type="text" name="last_name" id="id_last_name" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.last_name }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_CPF" class="block text-sm font-medium text-gray-700">CPF</label>
              <input type="text" name="CPF" id="id_CPF" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.CPF }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_telephone" class="block text-sm font-medium text-gray-700">Telefone</label>
              <input type="text" name="telephone" id="id_telephone" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.telephone }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_date_of_birth" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
              <input type="date" name="date_of_birth" id="id_date_of_birth" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.date_of_birth }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_occupational_registration" class="block text-sm font-medium text-gray-700">Registro Ocupacional</label>
              <input type="text" name="occupational_registration" id="id_occupational_registration" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.occupational_registration }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="md:col-span-2 pt-2">
              <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold shadow hover:bg-gray-900 transition">
                Confirmar alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Settings Card -->
    <div class="w-full max-w-5xl bg-white/90 backdrop-blur my-[1rem] rounded-2xl shadow-xl ring-1 ring-gray-100 p-6 md:p-8">
      <div class="flex flex-col gap-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-5">
          <div class="flex items-start gap-4">
            <img src="{% static 'assets/procedure.jpg' %}" alt="Configurações" class="w-16 h-16 md:w-20 md:h-20 rounded-2xl object-cover shadow-lg border border-gray-200">
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.28em] text-gray-500 mb-1">Configurações</p>
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 leading-tight">Preferências do Sistema</h2>
              <p class="text-sm text-gray-600">Gerencie suas configurações e preferências</p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <button onclick="toggleSettings()" type="button" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-black text-white text-sm font-semibold shadow hover:bg-gray-900 transition">
              <i class="fas fa-sliders-h"></i>
              Configurar
            </button>
          </div>
        </div>

        <!-- Settings Form -->
        <div class="settings-form hidden md:max-h-none max-h-[35vh] overflow-y-auto pr-1">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-gray-500">Ajustar preferências</p>
              <h3 class="text-lg font-semibold text-gray-900">Configurações da conta</h3>
            </div>
            <button onclick="toggleSettings()" type="button" class="text-gray-600 hover:text-gray-900 transition">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <form id="settings-form" action="#" method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Notifications Section -->
            <div class="border-b border-gray-200 pb-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">Notificações</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label for="email_notifications" class="text-sm text-gray-700">Notificações por email</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="email_notifications" name="email_notifications" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>

                <div class="flex items-center justify-between">
                  <label for="procedure_updates" class="text-sm text-gray-700">Atualizações de procedimentos</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="procedure_updates" name="procedure_updates" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>

                <div class="flex items-center justify-between">
                  <label for="favorite_alerts" class="text-sm text-gray-700">Alertas de favoritos</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="favorite_alerts" name="favorite_alerts" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Privacy Section -->
            <div class="border-b border-gray-200 pb-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">Privacidade</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label for="profile_visibility" class="text-sm text-gray-700">Perfil público</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="profile_visibility" name="profile_visibility" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>

                <div class="flex items-center justify-between">
                  <label for="show_activity" class="text-sm text-gray-700">Mostrar atividade recente</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="show_activity" name="show_activity" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Display Section -->
            <div class="border-b border-gray-200 pb-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">Exibição</h4>
              <div class="space-y-3">
                <div class="space-y-1">
                  <label for="theme" class="block text-sm font-medium text-gray-700">Tema</label>
                  <select id="theme" name="theme" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent">
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                    <option value="auto">Automático</option>
                  </select>
                </div>

                <div class="space-y-1">
                  <label for="language" class="block text-sm font-medium text-gray-700">Idioma</label>
                  <select id="language" name="language" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent">
                    <option value="pt-BR" selected>Português (Brasil)</option>
                    <option value="en">English</option>
                    <option value="es">Español</option>
                  </select>
                </div>

                <div class="flex items-center justify-between">
                  <label for="compact_view" class="text-sm text-gray-700">Modo compacto</label>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="compact_view" name="compact_view" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-[#42D1EB] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#42D1EB]"></div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Security Section -->
            <div class="pb-2">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">Segurança</h4>
              <div class="space-y-3">
                <button type="button" onclick="alert('Funcionalidade em desenvolvimento')" class="w-full text-left px-4 py-3 rounded-lg bg-gray-50 hover:bg-gray-100 border border-gray-200 transition">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-900">Alterar senha</p>
                      <p class="text-xs text-gray-500">Atualizar sua senha de acesso</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                  </div>
                </button>

                <button type="button" onclick="alert('Funcionalidade em desenvolvimento')" class="w-full text-left px-4 py-3 rounded-lg bg-gray-50 hover:bg-gray-100 border border-gray-200 transition">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-900">Autenticação de dois fatores</p>
                      <p class="text-xs text-gray-500">Adicionar camada extra de segurança</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                  </div>
                </button>
              </div>
            </div>

            <div class="pt-2">
              <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold shadow hover:bg-gray-900 transition">
                Salvar configurações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% include 'parciais/menu_inferior.html' %}
  </div>

  <script>
    function toggleForm() {
      document.querySelector('.profile-form').classList.toggle('hidden');
    }

    function toggleSettings() {
      document.querySelector('.settings-form').classList.toggle('hidden');
    }

    function showErrors(errors) {
      for (const [field, messages] of Object.entries(errors)) {
        const $field = $(`#id_${field}`);
    
        const isDateField = field === "date_of_birth";
        const $visibleInput = isDateField ? $field.siblings('input[type="text"]') : $();
    
        $field.add($visibleInput)
          .removeClass('bg-gray-100 border-gray-300')
          .addClass('border-red-500 bg-red-50');
    
        const $container = $field.closest('div');
        let $error = $container.find('.error-message');
    
        if (!$error.length) {
          $error = $('<div class="error-message text-sm text-red-600 mt-1"></div>').appendTo($container);
        }
    
        $error.text(messages.join(', ')).removeClass('hidden');
      }
    }
    
    
  </script>
  <script>
    $(document).ready(function () {
      $('#id_telephone').mask('(00) 00000-0000');
      $('#id_CPF').mask('000.000.000-00', { reverse: true });
    
      flatpickr("#id_date_of_birth", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true, // Permite digitação manual
        placeholder: "dd/mm/aaaa",
        onReady: function(selectedDates, dateStr, instance) {
          // Aplica máscara no input alternativo (visível)
          $(instance.altInput).mask('00/00/0000', {
            placeholder: "dd/mm/aaaa",
            onComplete: function(value) {
              // Converte dd/mm/yyyy para yyyy-mm-dd
              const parts = value.split('/');
              if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                const isoDate = `${year}-${month}-${day}`;
                
                // Valida e define a data no flatpickr
                const date = new Date(isoDate);
                if (!isNaN(date.getTime())) {
                  instance.setDate(isoDate, true);
                }
              }
            }
          });
        }
      });
    
      $(".chosen-select").chosen();
    
      // Limpa erro quando digita
      $('#profile-form input').on('input', function () {
        $(this)
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
        
        $(this).closest('div').find('.error-message')
          .addClass('hidden')
          .text('');
      });
    
      $('#profile-form').on('submit', function (e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();
    
        // Limpa os erros anteriores
        $form.find('.error-message').addClass('hidden').text('');
        $form.find('input')
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
    
        $.ajax({
          url: '/api/account/profile/users/validate/',
          method: 'POST',
          data: data,
          success: function () {
            $form.unbind('submit').submit(); // reenvia normalmente se validado
          },
          error: function (xhr) {
            const response = xhr.responseJSON;
            if (response && response.errors) {
              showErrors(response.errors);
            }
          }
        });
      });
    });
    
  </script>
  {% endblock %}
