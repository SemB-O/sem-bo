  {% extends 'base.html' %}
  {% load static %}

  {% block title %}Sem B.O{% endblock %}

  {% block head %}
    <link rel="stylesheet" href="{% static 'front/profile_style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>
  {% endblock %}

  {% block content %}
  <div class="flex flex-col items-center justify-center min-h-screen text-gray-800 pb-28 px-4">
    <div class="w-full max-w-4xl bg-white p-4 md:p-6 rounded-xl">
      <div class="flex flex-col md:flex-row items-center gap-4 md:gap-6 mb-6 border-b pb-4 text-center md:text-left">
        <div class="flex md:hidden justify-center items-center px-8 pt-6 w-[18rem] mx-auto mb-5 mt-4">
            <a href="{% url 'home' %}">
                <img src="{% static 'assets/logo.png' %}" alt="" class="mt-1.5">
            </a>
        </div>
        <img src="{% static 'assets/procedure.jpg' %}" alt="Foto de perfil" class="w-24 h-24 rounded-full object-cover shadow hidden md:flex">
        <div>
          <h2 class="text-2xl font-semibold">{{ request.user.first_name.title }} {{ request.user.last_name.title }}</h2>
          <p class="text-sm text-gray-600">{{ request.user.email }}</p>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <button onclick="toggleForm()" class="w-full bg-black text-white py-2 px-4 rounded-md hover:bg-gray-900 transition">
          Editar seu Perfil
        </button>
        <form action="/logout/" method="post" class="w-full">
          {% csrf_token %}
          <button type="submit" class="w-full bg-black text-white py-2 px-4 rounded-md flex items-center justify-center gap-2 hover:bg-gray-900 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="white" viewBox="0 -960 960 960">
              <path d="M216-144q-29.7 0-50.85-21.15Q144-186.3 144-216v-528q0-29.7 21.15-50.85Q186.3-816 216-816h264v72H216v528h264v72H216Zm432-168-51-51 81-81H384v-72h294l-81-81 51-51 168 168-168 168Z"/>
            </svg>
            Sair
          </button>
        </form>
      </div>

      <div class="profile-form hidden md:max-h-none max-h-[35vh] overflow-y-auto pr-2">
        <form id="profile-form" action="{% url 'profile' %}" method="post" class="flex flex-col gap-2 max-h-[35vh] overflow-scroll">
          {% csrf_token %}

          <div>
            <label for="id_first_name" class="block text-sm font-medium mb-1">Nome</label>
            <input type="text" name="first_name" id="id_first_name" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.first_name }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div>
            <label for="id_last_name" class="block text-sm font-medium mb-1">Sobrenome</label>
            <input type="text" name="last_name" id="id_last_name" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.last_name }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div>
            <label for="id_CPF" class="block text-sm font-medium mb-1">CPF</label>
            <input type="text" name="CPF" id="id_CPF" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.CPF }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div>
            <label for="id_telephone" class="block text-sm font-medium mb-1">Telefone</label>
            <input type="text" name="telephone" id="id_telephone" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.telephone }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div>
            <label for="id_date_of_birth" class="block text-sm font-medium mb-1">Data de Nascimento</label>
            <input type="date" name="date_of_birth" id="id_date_of_birth" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.date_of_birth }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div>
            <label for="id_occupational_registration" class="block text-sm font-medium mb-1">Registro Ocupacional</label>
            <input type="text" name="occupational_registration" id="id_occupational_registration" class="w-full px-3 py-2 rounded-md border bg-gray-100 focus:ring-blue-500 focus:border-blue-500" value="{{ request.user.occupational_registration }}">
            <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
          </div>

          <div class="col-span-1 md:col-span-2">
            <button type="submit" class="w-full bg-black text-white py-3 rounded-md hover:bg-gray-900 transition">
              Confirmar alterações
            </button>
          </div>
        </form>
      </div>
    </div>

    {% include 'parciais/menu_inferior.html' %}
  </div>

  <script>
    function toggleForm() {
      document.querySelector('.profile-form').classList.toggle('hidden');
    }

    function showErrors(errors) {
      for (const [field, messages] of Object.entries(errors)) {
        const $field = $(`#id_${field}`);
    
        const isDateField = field === "date_of_birth";
        const $visibleInput = isDateField ? $field.siblings('input[type="text"]') : $();
    
        $field.add($visibleInput)
          .removeClass('bg-gray-100 border-gray-300')
          .addClass('border-red-500 bg-red-50');
    
        const $container = $field.closest('div');
        let $error = $container.find('.error-message');
    
        if (!$error.length) {
          $error = $('<div class="error-message text-sm text-red-600 mt-1"></div>').appendTo($container);
        }
    
        $error.text(messages.join(', ')).removeClass('hidden');
      }
    }
    
    
  </script>
  <script>
    $(document).ready(function () {
      $('#id_telephone').mask('(00) 00000-0000');
      $('#id_CPF').mask('000.000.000-00', { reverse: true });
    
      flatpickr("#id_date_of_birth", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true, // Permite digitação manual
        placeholder: "dd/mm/aaaa",
        onReady: function(selectedDates, dateStr, instance) {
          // Aplica máscara no input alternativo (visível)
          $(instance.altInput).mask('00/00/0000', {
            placeholder: "dd/mm/aaaa",
            onComplete: function(value) {
              // Converte dd/mm/yyyy para yyyy-mm-dd
              const parts = value.split('/');
              if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                const isoDate = `${year}-${month}-${day}`;
                
                // Valida e define a data no flatpickr
                const date = new Date(isoDate);
                if (!isNaN(date.getTime())) {
                  instance.setDate(isoDate, true);
                }
              }
            }
          });
        }
      });
    
      $(".chosen-select").chosen();
    
      // Limpa erro quando digita
      $('#profile-form input').on('input', function () {
        $(this)
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
        
        $(this).closest('div').find('.error-message')
          .addClass('hidden')
          .text('');
      });
    
      $('#profile-form').on('submit', function (e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();
    
        // Limpa os erros anteriores
        $form.find('.error-message').addClass('hidden').text('');
        $form.find('input')
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
    
        $.ajax({
          url: '/api/account/profile/users/validate/',
          method: 'POST',
          data: data,
          success: function () {
            $form.unbind('submit').submit(); // reenvia normalmente se validado
          },
          error: function (xhr) {
            const response = xhr.responseJSON;
            if (response && response.errors) {
              showErrors(response.errors);
            }
          }
        });
      });
    });
    
  </script>
  {% endblock %}
