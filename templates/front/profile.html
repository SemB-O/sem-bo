  {% extends 'base.html' %}
  {% load static %}

  {% block title %}Sem B.O{% endblock %}

  {% block head %}
    <link rel="stylesheet" href="{% static 'front/profile_style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>
  {% endblock %}

  {% block content %}
  <div class="flex flex-col items-center justify-center min-h-screen text-gray-800 pb-28 px-4 bg-gradient-to-b from-slate-50 to-white">
    <div class="w-full max-w-5xl bg-white/90 backdrop-blur my-[3rem] rounded-2xl shadow-xl ring-1 ring-gray-100 p-6 md:p-8">
      <!-- Header -->
      <div class="flex flex-col gap-6 md:gap-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-5">
          <div class="flex items-start gap-4">
            <img src="{% static 'assets/procedure.jpg' %}" alt="Foto de perfil" class="w-16 h-16 md:w-20 md:h-20 rounded-2xl object-cover shadow-lg border border-gray-200">
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.28em] text-gray-500 mb-1">Perfil</p>
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 leading-tight truncate">{{ request.user.first_name.title }} {{ request.user.last_name.title }}</h2>
              <p class="text-sm text-gray-600 truncate">{{ request.user.email }}</p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <button onclick="toggleForm()" type="button" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-black text-white text-sm font-semibold shadow hover:bg-gray-900 transition">
              <i class="fa-regular fa-pen-to-square"></i>
              Editar perfil
            </button>
            <form action="/logout/" method="post" class="w-full sm:w-auto">
              {% csrf_token %}
              <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold border border-gray-200 hover:bg-gray-200 transition">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                Sair
              </button>
            </form>
          </div>
        </div>

        <!-- Key info badges -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 border border-gray-100">
            <div class="w-10 h-10 rounded-full border border-[#42D1EB66] text-[#0f4c5c] flex items-center justify-center shadow-sm">
              <i class="fa-regular fa-id-card"></i>
            </div>
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.15em] text-gray-500">CPF</p>
              <p class="text-sm font-semibold text-gray-900 truncate">{{ request.user.CPF|default:'—' }}</p>
            </div>
          </div>
          <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 border border-gray-100">
            <div class="w-10 h-10 rounded-full border border-[#42D1EB66] text-[#0f4c5c] flex items-center justify-center shadow-sm">
              <i class="fa-solid fa-phone"></i>
            </div>
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.15em] text-gray-500">Telefone</p>
              <p class="text-sm font-semibold text-gray-900 truncate">{{ request.user.telephone|default:'—' }}</p>
            </div>
          </div>
          <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 border border-gray-100">
            <div class="w-10 h-10 rounded-full border border-[#42D1EB66] text-[#0f4c5c] flex items-center justify-center shadow-sm">
              <i class="fa-regular fa-calendar"></i>
            </div>
            <div class="min-w-0">
              <p class="text-xs uppercase tracking-[0.15em] text-gray-500">Nascimento</p>
              <p class="text-sm font-semibold text-gray-900 truncate">{{ request.user.date_of_birth|default:'—' }}</p>
            </div>
          </div>
        </div>

        <!-- Form -->
        <div class="profile-form hidden md:max-h-none max-h-[35vh] overflow-y-auto pr-1">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-gray-500">Atualizar dados</p>
              <h3 class="text-lg font-semibold text-gray-900">Informações pessoais</h3>
            </div>
            <button onclick="toggleForm()" type="button" class="text-sm text-gray-600 hover:text-gray-900">Fechar</button>
          </div>
          <form id="profile-form" action="{% url 'profile' %}" method="post" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% csrf_token %}

            <div class="space-y-1">
              <label for="id_first_name" class="block text-sm font-medium text-gray-700">Nome</label>
              <input type="text" name="first_name" id="id_first_name" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.first_name }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_last_name" class="block text-sm font-medium text-gray-700">Sobrenome</label>
              <input type="text" name="last_name" id="id_last_name" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.last_name }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_CPF" class="block text-sm font-medium text-gray-700">CPF</label>
              <input type="text" name="CPF" id="id_CPF" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.CPF }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_telephone" class="block text-sm font-medium text-gray-700">Telefone</label>
              <input type="text" name="telephone" id="id_telephone" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.telephone }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_date_of_birth" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
              <input type="date" name="date_of_birth" id="id_date_of_birth" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.date_of_birth }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="space-y-1">
              <label for="id_occupational_registration" class="block text-sm font-medium text-gray-700">Registro Ocupacional</label>
              <input type="text" name="occupational_registration" id="id_occupational_registration" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-[#42D1EB] focus:border-transparent" value="{{ request.user.occupational_registration }}">
              <div class="error-message text-sm text-red-600 hidden"></div>
            </div>

            <div class="md:col-span-2 pt-2">
              <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold shadow hover:bg-gray-900 transition">
                Confirmar alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% include 'parciais/menu_inferior.html' %}
  </div>

  <script>
    function toggleForm() {
      document.querySelector('.profile-form').classList.toggle('hidden');
    }

    function showErrors(errors) {
      for (const [field, messages] of Object.entries(errors)) {
        const $field = $(`#id_${field}`);
    
        const isDateField = field === "date_of_birth";
        const $visibleInput = isDateField ? $field.siblings('input[type="text"]') : $();
    
        $field.add($visibleInput)
          .removeClass('bg-gray-100 border-gray-300')
          .addClass('border-red-500 bg-red-50');
    
        const $container = $field.closest('div');
        let $error = $container.find('.error-message');
    
        if (!$error.length) {
          $error = $('<div class="error-message text-sm text-red-600 mt-1"></div>').appendTo($container);
        }
    
        $error.text(messages.join(', ')).removeClass('hidden');
      }
    }
    
    
  </script>
  <script>
    $(document).ready(function () {
      $('#id_telephone').mask('(00) 00000-0000');
      $('#id_CPF').mask('000.000.000-00', { reverse: true });
    
      flatpickr("#id_date_of_birth", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true, // Permite digitação manual
        placeholder: "dd/mm/aaaa",
        onReady: function(selectedDates, dateStr, instance) {
          // Aplica máscara no input alternativo (visível)
          $(instance.altInput).mask('00/00/0000', {
            placeholder: "dd/mm/aaaa",
            onComplete: function(value) {
              // Converte dd/mm/yyyy para yyyy-mm-dd
              const parts = value.split('/');
              if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                const isoDate = `${year}-${month}-${day}`;
                
                // Valida e define a data no flatpickr
                const date = new Date(isoDate);
                if (!isNaN(date.getTime())) {
                  instance.setDate(isoDate, true);
                }
              }
            }
          });
        }
      });
    
      $(".chosen-select").chosen();
    
      // Limpa erro quando digita
      $('#profile-form input').on('input', function () {
        $(this)
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
        
        $(this).closest('div').find('.error-message')
          .addClass('hidden')
          .text('');
      });
    
      $('#profile-form').on('submit', function (e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();
    
        // Limpa os erros anteriores
        $form.find('.error-message').addClass('hidden').text('');
        $form.find('input')
          .removeClass('border-red-500 bg-red-50')
          .addClass('border-gray-300');
    
        $.ajax({
          url: '/api/account/profile/users/validate/',
          method: 'POST',
          data: data,
          success: function () {
            $form.unbind('submit').submit(); // reenvia normalmente se validado
          },
          error: function (xhr) {
            const response = xhr.responseJSON;
            if (response && response.errors) {
              showErrors(response.errors);
            }
          }
        });
      });
    });
    
  </script>
  {% endblock %}
