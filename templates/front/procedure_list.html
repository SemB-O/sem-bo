{% extends 'base.html' %}
{%  load static %}

{% block title %}

Sem B.O

{% endblock %}

{% block head %}

    <link rel="stylesheet" href="{% static 'front/procedure_list_style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap">
    
    <style>
        /* ========== CUSTOMIZAÇÃO SELECT2 - PADRÃO DO SISTEMA ========== */
        
        /* Container principal do Select2 */
        .select2-container--default .select2-selection--multiple {
            background-color: #F2F2F7 !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            padding: 0.25rem 0.5rem !important;
            min-height: 42px !important;
        }

        .select2-container .select2-selection--single, .select2-container .select2-selection--multiple {
            align-items: baseline;
            margin-top: 0 !important;
        }
        
        /* Tags selecionadas */
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #0F0F0F !important;
            border: 1px solid #000000 !important;
            border-radius: 0.25rem !important;
            padding: 4px 8px !important;
            margin: 4px 4px 4px 0 !important;
            color: white !important;
            font-size: 0.875rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important; /* Espaço entre X e texto */
        }

        .select2-selection__choice__display {
            margin-left: 0.7rem;
        }
        
        /* Botão X para remover tag */
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            margin-right: 0 !important; /* Removido margin, usando gap no pai */
            font-size: 1rem !important;
            font-weight: bold !important;
            border: none !important;
            margin-top: 0.2rem;
            background: transparent !important;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: #0F0F0F !important;
            background: transparent !important;
        }
        
        /* Campo de busca dentro do select */
        .select2-container--default .select2-search--inline .select2-search__field {
            margin-top: 4px !important;
            padding: 0 !important;
            font-size: 0.875rem !important;
        }
        
        /* Dropdown */
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #42D1EB !important;
            color: white !important;
        }
        
        /* Opção selecionada no dropdown */
        .select2-container--default .select2-results__option[aria-selected="true"] {
            background-color: #e5f6fb !important;
            color: #0F0F0F !important;
        }
        
        /* Dropdown container */
        .select2-dropdown {
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Mensagem "Pesquisando..." */
        .select2-container--default .select2-results__option--disabled {
            color: #6b7280 !important;
        }

        /* Placeholder */
        .select2-container--default .select2-selection--multiple .select2-selection__placeholder {
            color: #6b7280 !important;
        }

        /* ========== HOVERS E ANIMAÇÕES (PADRÃO HOME) ========== */
        
        /* Ícone de favorito */
        .favorite-icon {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-icon:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }

        .favorite-icon:active {
            transform: scale(1.1);
        }

        /* Código do procedimento */
        .procedure_code {
            background-color: #7d838b;
            display: flex;
            width: 8rem;
            height: 3.2rem;
            border-radius: 0.3rem;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
            text-align: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            position: relative;
            user-select: none;
        }

        .procedure_code:hover {
            background-color: #5a6069;
            transform: translateY(-2px);
        }

        .procedure_code:active {
            transform: translateY(0);
        }

        /* Ícone de copiar no hover */
        .procedure_code::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .procedure_code:hover::after {
            opacity: 0.8;
        }

        .right_info {
            align-items: center;
        }

        /* Botão de ajuda */
        .help {
            background-color: #f3f3f899;
            display: flex;
            width: 3.5rem;
            height: 3.2rem;
            border-radius: 0 1rem 1rem 0;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .help:hover {
            background-color: #e0e0e0;
            transform: translateX(2px);
        }

        .help:active {
            transform: translateX(0);
            background-color: #d5d5d5;
        }

        .help ion-icon {
            font-size: 1.5rem;
        }

        /* Botão Load More */
        #load-more {
            transition: all 0.3s ease;
        }

        #load-more:hover {
            background-color: RGB(235, 235, 239);
            transform: translateY(-2px);
        }

        #load-more:active {
            transform: translateY(0);
        }

        /* ========== MODAL - ESTILO MODERNO ========== */

        /* Animação suave de entrada do modal */
        .modal-content {
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Checkbox customizado para consistência */
        .checkbox-custom {
            cursor: pointer;
            accent-color: #1f2937;
        }

        /* Folder item hover effect */
        .folder-item label:hover {
            transform: translateX(2px);
        }
    </style>
{% endblock %}

{% block content %}

{% include 'parciais/menu.html' %}

<div class="mx-[1rem] md:mx-[5rem]">
<form id="search-form" class="form-search" method="GET" action="{% url 'procedure_more' %}">
    {% csrf_token %}
    <div class="search flex items-center bg-transparent pt-2 pb-2 w-full">
        <div class="mr-2 w-full">
            <input type="text" name="q" class="block rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-[0.85rem] bg-[#F2F2F7] w-full" placeholder="Digite o procedimento">
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button type="submit" aria-label="search" class="flex items-center rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition">
                <ion-icon name="search-outline" class="w-8 h-8 md:w-5 md:h-5 hydrated" role="img"></ion-icon>
            </button>
            <button type="button" id="filter" id="open-filter-modal" aria-label="filter" class="flex items-center justify-center rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition">
                <ion-icon name="options-outline" class="w-8 h-8 md:w-6 md:h-6 hydrated" role="img"></ion-icon>
            </button>
        </div>
    </div>
</form>

<div class="results">
    {% for procedure in procedures %}
        <div class="procedure p-4 my-2 border rounded-lg">
            <div class="title_tags">
                <a class="font-bold opacity-80" style="font-size: 14px;" href="{% url 'procedure_detail' procedure_code=procedure.procedure_code %}">{{ procedure }}</a>
                <div class="records_tags mt-2 md:mt-0 flex">
                    {% with total_tags=procedure.related_occupations_names|length|add:procedure.get_records_names|length %}
                    
                    {% for occupation in procedure.related_occupations_names %}
                        <a class="procedure-occupation tag-item" {% if forloop.counter > 2 %}style="display: none;"{% endif %}>
                            {% if occupation|length > 20 %}{{ occupation|slice:":20" }}...{% else %}{{ occupation }}{% endif %}
                        </a>
                    {% endfor %}
                    
                    {% for record in procedure.get_records_names %}
                        <a class="tag-item" {% if procedure.related_occupations_names|length|add:forloop.counter > 2 %}style="display: none;"{% endif %}>
                            {% if record|length > 20 %}{{ record|slice:":20" }}...{% else %}{{ record }}{% endif %}
                        </a>
                    {% endfor %}
                    
                    {% if total_tags > 2 %}
                        <span class="more-tags-indicator inline-flex items-center rounded-full bg-slate-100 text-slate-600 px-2 py-0.5 text-[11px] font-semibold" title="Clique no procedimento para ver todos os detalhes">+{{ total_tags|add:"-2" }}</span>
                    {% endif %}
                    
                    {% endwith %}
                </div>
            </div>
            <div class="right_info">
                {% if procedure.procedure_code in favorite %}
                    <ion-icon name="bookmark" class="w-[10%] md:w-10 h-5 favorite-icon cursor-pointer md hydrated text-slate-500 hover:text-cyan-600 transition-colors" data-procedure-id="{{ procedure.procedure_code }}" role="img"></ion-icon>
                {% else %}
                    <ion-icon name="bookmark-outline" class="w-[10%] md:w-10 h-5 favorite-icon cursor-pointer md hydrated text-slate-500 hover:text-cyan-600 transition-colors" data-procedure-id="{{ procedure.procedure_code }}" role="img"></ion-icon>
                {% endif %}
                <div class="procedure_code w-[70%] md:w-[8rem]">{{ procedure.procedure_code }}</div>
                <a class="help-icon w-[20%] md:w-10 md:mr-4 text-slate-500 hover:text-cyan-600 transition-colors" href="{% url 'procedure_detail' procedure_code=procedure.procedure_code %}">
                    <div class="help">
                        <ion-icon name="help-circle-outline" role="img" class="md hydrated"></ion-icon>
                    </div>
                </a>
            </div>
        </div>
    {% endfor %}
    <button id="load-more" class="flex items-center rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7]" style="display: {% if procedures.has_next %}block{% else %}none{% endif %};">Carregar Mais</button>
    <div class="flex items-center rounded-md border border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7]" style="display: none;">Carregando...</div>
</div>

    <div class="content-principal flex items-center justify-center min-h-screen md:block">
        <div class="modal-content bg-white w-11/12 md:w-2/3 lg:w-1/3 mx-auto mt-0 md:mt-10 rounded-2xl p-6 shadow-2xl hidden">
            <div class="flex justify-between items-center mb-2">
                <div></div>
                <h2 class="text-2xl font-bold text-gray-800 text-center">
                    <i class="fas fa-filter mr-2" style="color: #42D1EB;"></i>
                    Filtro de Resultados
                </h2>
                <button class="close text-gray-400 hover:text-gray-600 transition-colors text-2xl leading-none" id="close-modal" aria-label="Fechar">
                    &times;
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4 text-center">Refine sua busca selecionando os tipos de registro desejados</p>
        
            <div class="mt-2">
                <label for="record-name-filter" class="text-gray-700 font-semibold block mb-3">
                    <i class="fas fa-list-check mr-2 text-gray-500"></i>
                    Tipos de Registro
                </label>
                <select id="record-name-filter" class="block w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent filter-results" multiple="multiple">
                    {% for record in records %}
                        {% if record.name %}
                        <option value="{{ record.name }}">{{ record.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        
            <div class="mt-6 flex gap-3">
                <button id="clear-filter" class="bg-gray-100 text-gray-700 font-semibold flex-1 py-3 px-4 rounded-lg hover:bg-gray-200 transition-all duration-300 border border-gray-200 shadow-sm hover:shadow">
                    <i class="fas fa-times mr-2"></i>Limpar
                </button>
                <button id="apply-filter" class="bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-900 text-white font-semibold flex-1 py-3 px-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-check mr-2"></i>Aplicar Filtro
                </button>
            </div>
        </div>
        <div class="blur hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm"></div>
    </div>
</div>

<div class="content-principal folder-modal">
    <div id="favorite-modal" class="modal hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-60 backdrop-blur-sm z-50">
        <div class="modal-content-folder bg-white w-11/12 md:w-2/3 lg:w-1/3 mx-auto rounded-2xl p-6 max-h-[80vh] overflow-auto shadow-2xl">
            <div class="sup-folder flex justify-between items-center mb-6">
                <div></div>
                <h2 class="text-xl font-bold text-gray-800 text-center">
                    <i class="fas fa-folder text-yellow-500 mr-2"></i>
                    Pastas de Favoritos
                </h2>
                <button class="close text-gray-400 hover:text-gray-600 transition-colors text-2xl leading-none" aria-label="Fechar">
                    &times;
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4 text-center">Selecione as pastas onde deseja salvar este procedimento</p>
            
            <ul class="mb-6 space-y-2">
                {% for folder in favorite_folders %}
                <li class="folder-item">
                    <label for="folder-{{ folder.id }}" class="label-folder cursor-pointer list-folders flex justify-between items-center bg-gray-50 hover:bg-gray-100 p-4 rounded-lg transition-colors border border-gray-200">
                        <span class="truncate max-w-[70%] font-medium text-gray-700">
                            <i class="fas fa-folder-open text-yellow-500 mr-2"></i>
                            {{ folder.name }}
                        </span>
                        <input type="checkbox" id="folder-{{ folder.id }}" name="folders" value="{{ folder.id }}" class="checkbox-custom w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" {% if folder.name == 'Geral' %}checked{% endif %}>
                    </label>
                </li>
                {% endfor %}
            </ul>
            
            <button id="confirm-favorite" class="bg-gradient-to-r from-gray-900 to-black hover:from-black hover:to-gray-900 text-white w-full py-3 px-4 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                <i class="fas fa-check mr-2"></i>Confirmar
            </button>
        </div>
    </div>
    <div class="blur hidden"></div>
</div>

{% include 'parciais/menu_inferior.html' %}

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<script>
/**
 * Procedure List Page - Refatorado
 * Arquitetura modular com prevenção de XSS e event delegation
 */
$(document).ready(function() {
    // ================== CONFIGURAÇÃO ==================
    const CONFIG = {
        INITIAL_PAGE: 2,
        FEEDBACK_DURATION: 2000
    };

    const STATE = {
        page: CONFIG.INITIAL_PAGE,
        loading: false
    };

    // ================== UTILITÁRIOS ==================
    const Utils = {
        escapeHtml: function(text) {
            if (!text) return '';
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        },

        copyToClipboard: function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => Feedback.show('Código copiado!', true))
                    .catch(() => this.fallbackCopy(text));
            } else {
                this.fallbackCopy(text);
            }
        },

        fallbackCopy: function(text) {
            const textarea = $('<textarea>').val(text).css({position: 'fixed', opacity: 0});
            $('body').append(textarea);
            textarea[0].select();
            try {
                document.execCommand('copy');
                Feedback.show('Código copiado!', true);
            } catch (err) {
                Feedback.show('Falha ao copiar', false);
            }
            textarea.remove();
        }
    };

    // ================== FEEDBACK ==================
    const Feedback = {
        show: function(message, success = true) {
            $('.copy-feedback').remove();
            const icon = success ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
            const feedback = $('<div class="copy-feedback"></div>')
                .html(icon + ' <span>' + Utils.escapeHtml(message) + '</span>')
                .css({
                    position: 'fixed', top: '20px', right: '20px',
                    backgroundColor: success ? '#10b981' : '#ef4444',
                    color: 'white', padding: '12px 20px', borderRadius: '8px',
                    zIndex: '10001', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    display: 'flex', alignItems: 'center', gap: '8px'
                });
            $('body').append(feedback);
            setTimeout(() => feedback.fadeOut(300, function() { $(this).remove(); }), CONFIG.FEEDBACK_DURATION);
        }
    };

    // ================== RENDERIZAÇÃO ==================
    const ProcedureRenderer = {
        truncateText: function(text, maxLength = 20) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        },
        
        create: function(procedure) {
            const baseUrl = "{% url 'procedure_detail' procedure_code='__CODE__' %}";
            const url = baseUrl.replace('__CODE__', procedure.code);
            const icon = procedure.favorite ? 'bookmark' : 'bookmark-outline';
            
            // Combina ocupações e registros
            let allTags = [];
            if (procedure.occupations_of_users) {
                allTags = allTags.concat(procedure.occupations_of_users.map(o => ({
                    text: o,
                    isOccupation: true
                })));
            }
            if (procedure.records_names) {
                allTags = allTags.concat(procedure.records_names.map(r => ({
                    text: r,
                    isOccupation: false
                })));
            }
            
            // Renderiza tags com limite máximo de 2
            let tagsHTML = '';
            const maxVisibleTags = 2;
            const visibleTags = allTags.slice(0, maxVisibleTags);
            const hiddenCount = Math.max(0, allTags.length - maxVisibleTags);
            
            visibleTags.forEach(tag => {
                const truncated = this.truncateText(tag.text, 20);
                const className = tag.isOccupation ? 'procedure-occupation' : '';
                tagsHTML += '<a class="' + className + ' tag-item">' + Utils.escapeHtml(truncated) + '</a>';
            });
            
            // Adiciona indicador de mais tags se houver
            if (hiddenCount > 0) {
                tagsHTML += '<span class="more-tags-indicator inline-flex items-center rounded-full bg-slate-100 text-slate-600 px-2 py-0.5 text-[11px] font-semibold" title="Clique no procedimento para ver todos os detalhes">+' + hiddenCount + '</span>';
            }

            return '<div class="procedure p-4 my-2 border rounded-lg">' +
                '<div class="title_tags">' +
                '<a class="font-bold opacity-80" style="font-size: 14px;" href="' + url + '">' + Utils.escapeHtml(procedure.name) + '</a>' +
                '<div class="records_tags mt-2 md:mt-0 flex">' + tagsHTML + '</div>' +
                '</div>' +
                '<div class="right_info">' +
                '<ion-icon name="' + icon + '" class="w-[10%] md:w-10 h-5 favorite-icon cursor-pointer md hydrated text-slate-500 hover:text-cyan-600 transition-colors" data-procedure-id="' + Utils.escapeHtml(procedure.code) + '"></ion-icon>' +
                '<div class="procedure_code w-[70%] md:w-[8rem]">' + Utils.escapeHtml(procedure.code) + '</div>' +
                '<a class="help-icon w-[20%] md:w-10 md:mr-4 text-slate-500 hover:text-cyan-600 transition-colors" href="' + url + '"><div class="help"><ion-icon name="help-circle-outline"></ion-icon></div></a>' +
                '</div>' +
                '</div>';
        }
    };

    // ================== LOAD MORE ==================
    $(document).on('click', '#load-more', function() {
        if (STATE.loading) return;
        STATE.loading = true;
        $('#load-more').hide();
        $('.loading').show();

        const query = $('input[name="q"]').val().trim();
        const records = $('#record-name-filter').val(); // Array de múltiplos valores

        $.ajax({
            type: 'GET',
            url: "{% url 'procedure_more' %}",
            data: { 
                page: STATE.page, 
                q: query, 
                record_name: records ? records.join(',') : '' 
            },
            success: function(data) {
                if (data.procedures && data.procedures.length > 0) {
                    const html = data.procedures.map(p => ProcedureRenderer.create(p)).join('');
                    $('#load-more').before(html);
                    
                    if (!data.procedures[0].has_more_results) {
                        $('#load-more').remove();
                        $('.loading').remove();
                    } else {
                        STATE.page++;
                    }
                }
                STATE.loading = false;
                $('.loading').hide();
                $('#load-more').show();
            },
            error: function() {
                Feedback.show('Erro ao carregar mais procedimentos', false);
                STATE.loading = false;
                $('.loading').hide();
                $('#load-more').show();
            }
        });
    });

    // ================== BUSCA ==================
    $('#search-form').submit(function(e) {
        e.preventDefault();
        const query = $('input[name="q"]').val().trim();
        const records = $('#record-name-filter').val(); // Array de múltiplos valores

        $('.results').empty();
        STATE.page = CONFIG.INITIAL_PAGE;

        $.ajax({
            type: 'GET',
            url: $(this).attr('action'),
            data: { 
                q: query, 
                record_name: records ? records.join(',') : '' 
            },
            success: function(data) {
                if (data.procedures && data.procedures.length > 0) {
                    const html = data.procedures.map(p => ProcedureRenderer.create(p)).join('');
                    $('.results').html(html);
                    
                    if (data.procedures[0].has_more_results) {
                        $('.results').append('<button id="load-more" class="flex items-center rounded-md border border-gray-300 shadow-sm px-3 py-2.5 bg-[#F2F2F7] hover:bg-gray-200 transition">Carregar Mais</button>');
                        $('.results').append('<div class="loading flex items-center rounded-md border border-gray-300 shadow-sm px-3 py-2.5 bg-[#F2F2F7]" style="display: none;">Carregando...</div>');
                    }
                } else {
                    $('.results').html('<p class="no-procedures p-4 text-center text-gray-600">Procedimento não encontrado ou não disponível para sua ocupação</p>');
                }
            },
            error: function() {
                Feedback.show('Erro na busca', false);
            }
        });
    });

    // ================== EVENT DELEGATION - COPIAR ==================
    $(document).on('click', '.procedure_code', function() {
        const code = $(this).text().trim();
        Utils.copyToClipboard(code);
    });
});
</script>

<script>
// ================== MODAL DE FILTRO ==================
document.addEventListener("DOMContentLoaded", function() {
    const filterModal = document.querySelector(".modal-content");
    const filterBtn = document.getElementById("filter");
    const closeBtn = document.getElementById("close-modal");
    const applyBtn = document.getElementById("apply-filter");
    const clearBtn = document.getElementById("clear-filter");
    const blur = document.querySelector(".blur");

    if (filterBtn && filterModal) {
        // Abrir modal
        filterBtn.addEventListener("click", function() {
            filterModal.style.display = "block";
            blur.style.display = "block";
            blur.classList.remove('hidden');
            
            // Inicializa Select2 com configuração de múltipla seleção
            $('#record-name-filter').select2({
                placeholder: 'Selecione os tipos de registro',
                allowClear: true,
                width: '100%',
                dropdownParent: filterModal,
                language: {
                    noResults: function() {
                        return "Nenhum resultado encontrado";
                    }
                }
            });
        });

        // Fechar modal com botão X
        closeBtn.addEventListener("click", function() {
            filterModal.style.display = "none";
            blur.style.display = "none";
            blur.classList.add('hidden');
            $('#record-name-filter').select2('destroy');
        });

        // Fechar modal clicando no blur
        blur.addEventListener("click", function() {
            filterModal.style.display = "none";
            blur.style.display = "none";
            blur.classList.add('hidden');
            $('#favorite-modal').addClass('hidden');
            $('#record-name-filter').select2('destroy');
        });

        // Fechar modal com tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && filterModal.style.display === 'block') {
                filterModal.style.display = "none";
                blur.style.display = "none";
                blur.classList.add('hidden');
                $('#record-name-filter').select2('destroy');
            }
        });

        // Botão Limpar - reseta o filtro e recarrega
        if (clearBtn) {
            clearBtn.addEventListener("click", function() {
                $('#record-name-filter').val(null).trigger('change');
                filterModal.style.display = "none";
                blur.style.display = "none";
                blur.classList.add('hidden');
                $('#record-name-filter').select2('destroy');
                window.location.href = '/procedures/';
            });
        }

        // Botão Aplicar - aplica o filtro com seleções múltiplas
        applyBtn.addEventListener("click", function() {
            filterModal.style.display = "none";
            blur.style.display = "none";
            blur.classList.add('hidden');
            
            const selected = $('#record-name-filter').val(); // Array
            $('#record-name-filter').select2('destroy');
            
            const params = new URLSearchParams(window.location.search);
            if (selected && selected.length > 0) {
                params.set('record_name', selected.join(','));
            } else {
                params.delete('record_name');
            }
            window.location.href = '/procedures/?' + params.toString();
        });
    }
});
</script>

<script>
// ================== MODAL DE FAVORITOS - EVENT DELEGATION ==================
$(document).ready(function() {
    const favoriteModal = $('#favorite-modal');
    const blur = $('.blur');
    let currentProcedureCode = '';

    // Event delegation para ícones de favorito (funciona com elementos dinâmicos)
    $(document).on('click', '.favorite-icon', function() {
        currentProcedureCode = $(this).data('procedure-id');
        favoriteModal.removeClass('hidden');
        blur.show();

        // Buscar status do favorito
        $.ajax({
            url: '/check_favorite/',
            type: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            data: { 'procedure_id': currentProcedureCode },
            success: function(data) {
                // Desmarcar todos primeiro
                $('input[name="folders"]').prop('checked', false);

                if (data.is_favorite && data.favorite_folders) {
                    // Marcar os folders onde está favoritado
                    data.favorite_folders.forEach(function(folderId) {
                        $('input[name="folders"][value="' + folderId + '"]').prop('checked', true);
                    });
                } else {
                    // Marcar "Geral" por padrão
                    $('input[name="folders"][value="1"]').prop('checked', true);
                }
            },
            error: function(error) {
                console.error('Erro ao verificar favorito:', error);
            }
        });
    });

    // Fechar modal
    $('#favorite-modal .close').on('click', function() {
        favoriteModal.addClass('hidden');
        blur.hide();
    });

    // Confirmar favorito
    $('#confirm-favorite').on('click', function() {
        const selectedFolders = $('input[name="folders"]:checked').map(function() {
            return $(this).val();
        }).get();

        $.ajax({
            url: '/add-remove-favorite/',
            type: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            data: {
                'folders': selectedFolders,
                'procedure_id': currentProcedureCode
            },
            success: function(data) {
                // Atualizar ícone
                const icon = $('[data-procedure-id="' + currentProcedureCode + '"]');
                if (data.is_favorite) {
                    icon.attr('name', 'bookmark');
                } else {
                    icon.attr('name', 'bookmark-outline');
                }
                
                favoriteModal.addClass('hidden');
                blur.hide();
            },
            error: function(error) {
                console.error('Erro ao salvar favorito:', error);
                alert('Erro ao salvar favorito. Tente novamente.');
            }
        });
    });
});
</script>

{% endblock %}