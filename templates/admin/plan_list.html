{% extends 'admin/base_admin.html' %}

{% block page_title %}Gerenciar Planos{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="w-full sm:flex-1 sm:max-w-lg">
        <form method="get" class="relative">
            <input type="text" name="search" value="{{ search }}" placeholder="Buscar planos..." class="w-full px-4 py-3 pl-12 rounded-lg border border-slate-200 bg-white text-slate-700 placeholder:text-slate-400 focus:border-primary focus:ring-2 focus:ring-cyan-100 transition">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </form>
    </div>
    <a href="{% url 'admin-plan-create' %}" class="w-full sm:w-auto sm:ml-4 bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark transition font-medium text-center shadow-sm">
        <i class="fas fa-plus mr-2"></i>
        Novo Plano
    </a>
</div>

{% if plans %}
<div class="md:hidden space-y-4">
    {% for plan in plans %}
    <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
        <div class="flex items-start justify-between gap-3">
            <div>
                <div class="font-semibold text-gray-900">{{ plan.name }}</div>
                <div class="text-sm text-gray-500 mt-1">{{ plan.description|truncatewords:12 }}</div>
            </div>
            <span class="font-semibold text-primary whitespace-nowrap">R$ {{ plan.price }}</span>
        </div>
        <div class="mt-3 flex flex-wrap gap-2 text-xs">
            <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-100 text-slate-700">
                <i class="fas fa-user-tie mr-1"></i>
                {{ plan.max_occupations }} ocupações
            </span>
            <span class="inline-flex items-center px-2 py-1 rounded-full bg-cyan-100 text-cyan-800">
                <i class="fas fa-gift mr-1"></i>
                {{ plan.benefit_count }} benefícios
            </span>
            {% if plan.is_active %}
            <span class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-1"></i>Ativo
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-1 rounded-full bg-slate-100 text-slate-700">
                <i class="fas fa-times-circle mr-1"></i>Inativo
            </span>
            {% endif %}
        </div>
        <div class="mt-4 flex items-center justify-end gap-2">
            <a href="{% url 'admin-plan-edit' plan.id %}" class="inline-flex items-center px-3 py-2 bg-slate-50 text-slate-700 rounded-lg hover:bg-slate-100 transition text-sm font-medium">
                <i class="fas fa-edit"></i>
            </a>
            <button data-plan-delete data-plan-id="{{ plan.id }}" data-plan-name="{{ plan.name|escapejs }}" class="inline-flex items-center px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition text-sm font-medium">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
<div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100">
    <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
            <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Plano</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Preço</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Ocupações Máx.</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Benefícios</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Ações</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-100">
            {% for plan in plans %}
            <tr class="hover:bg-slate-50 transition">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div>
                            <div class="font-semibold text-slate-900">{{ plan.name }}</div>
                            <div class="text-sm text-slate-500 line-clamp-1">{{ plan.description|truncatewords:10 }}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="font-semibold text-primary">R$ {{ plan.price }}</span>
                </td>
                <td class="px-6 py-4 text-slate-700">
                    {{ plan.max_occupations }}
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 bg-cyan-100 text-cyan-800 text-sm font-medium rounded-full">
                        {{ plan.benefit_count }}
                    </span>
                </td>
                <td class="px-6 py-4">
                    {% if plan.is_active %}
                    <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">
                        <i class="fas fa-check-circle mr-1"></i>Ativo
                    </span>
                    {% else %}
                    <span class="px-3 py-1 bg-gray-100 text-gray-800 text-sm font-medium rounded-full">
                        <i class="fas fa-times-circle mr-1"></i>Inativo
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-right space-x-2">
                    <a href="{% url 'admin-plan-edit' plan.id %}" class="inline-flex items-center px-3 py-2 bg-slate-50 text-slate-700 rounded-lg hover:bg-slate-100 transition text-sm font-medium">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button data-plan-delete data-plan-id="{{ plan.id }}" data-plan-name="{{ plan.name|escapejs }}" class="inline-flex items-center px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition text-sm font-medium">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white rounded-xl shadow-sm p-12 text-center">
    <i class="fas fa-box text-6xl text-gray-300 mb-4"></i>
    <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhum plano encontrado</h3>
    <p class="text-gray-500 mb-6">Comece criando seu primeiro plano</p>
    <a href="{% url 'admin-plan-create' %}" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-medium shadow-sm">
        <i class="fas fa-plus mr-2"></i>
        Criar Plano
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function confirmDelete(planId, planName) {
    Swal.fire({
        title: 'Confirmar Exclusão',
        html: `Tem certeza que deseja excluir o plano <strong>${planName}</strong>?<br><small class="text-gray-500">Esta ação não pode ser desfeita.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar',
        customClass: {
            confirmButton: 'bg-red-500 text-white hover:bg-red-600 px-6 py-2 rounded-lg transition mr-2',
            cancelButton: 'bg-gray-300 text-gray-700 hover:bg-gray-400 px-6 py-2 rounded-lg transition'
        },
        buttonsStyling: false
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/plans/${planId}/delete/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                form.appendChild(csrfToken.cloneNode(true));
            } else {
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = '{{ csrf_token }}';
                form.appendChild(csrf);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}

document.querySelectorAll('[data-plan-delete]').forEach((button) => {
    button.addEventListener('click', () => {
        confirmDelete(button.dataset.planId, button.dataset.planName);
    });
});
</script>
{% endblock %}
