{% extends 'base.html' %}
{% load static %}

{% block title %}
    Sem B.O
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'front/medical_record_list_style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap">
{% endblock %}

{% block content %}
    {% include 'parciais/menu.html' %}

    <form id="search-form" class="form-search" action="{% url 'medical_record_search' %}">
        {% csrf_token %}
        <div class="flex justify-center ml-4 mr-4">
            <div class="search flex items-center bg-transparent p-2">
                <input type="text" class="search bg-white focus:outline-none w-full p-2.5 opacity-90" placeholder="Pesquisar ProntuÃ¡rios" name="q">
                <ion-icon class="w-6 h-6 absolute text-gray-600 opacity-40" name="search-outline"></ion-icon>
            </div>
            <div id="filter" class="filter bg-F4F4F8 flex justify-center items-center">
                <ion-icon name="options-outline" class="w-6 h-6"></ion-icon>
            </div>
            <div id="close-filter" class="filter bg-F4F4F8 flex justify-center items-center" style="display: none; background-color: rgb(243 106 106 / 85%)">
                <ion-icon name="close-outline" style="color: white;" class="w-6 h-6"></ion-icon>
            </div>
        </div>
    </form>

    <div class="results">
        {% for medical_record in medical_records %}
            <div class="medical_record p-4 my-2 border rounded-lg">
                <div class="title_tags">
                    <a class="title_medical_record" href="{% url 'view_single_medical_record' medical_record.id %}">{{ medical_record.patient.name }}</a>
                    <h5 class="medical_record-occupation" href="#">{{ medical_record.created_at }}</h5>
                </div>
                <div class="right_info">
                    <div class="medical_record_code">{{ medical_record.record_type }}</div>
                    <a class="view-icon" href="{% url 'view_single_medical_record' medical_record.id %}">
                        <div class="view">
                            <ion-icon name="eye-outline" role="img" class="md hydrated"></ion-icon>
                        </div>
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>

    {% include 'parciais/menu_inferior.html' %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let page = 1;
            let loading = false;
            let searchActive = false;

            const form = $('#search-form');
            const resultsAll = $('.results');
            const optionsIcon = $('#filter');
            const closeIcon = $('#close-filter');

            function handleFormSubmit(e) {
                e.preventDefault();

                searchActive = true;
                toggleFilterVisibility(searchActive);

                resultsAll.empty();
                const query = form.find('input[name="q"]').val().trim();

                fetchRecords(query);
            }

            function fetchRecords(query, page = 1) {
                $.ajax({
                    type: "GET",
                    url: form.attr('action'),
                    data: { 'q': query, 'page': page },
                    success: function (data) {
                        handleAjaxSuccess(data, query);
                    }
                });
            }

            function handleAjaxSuccess(data, query) {
                if (data.records && data.records.length > 0) {
                    const recordsHTML = data.records.map(createRecordHTML).join('');
                    resultsAll.append(recordsHTML);

                    if (data.records[0].has_more_results) {
                        resultsAll.append('<button id="load-more" style="display: block;">Carregar Mais</button>');
                        resultsAll.append('<div class="loading" style="display: none;">carregando...</div>');
                        setupLoadMoreButton(query);
                    }

                    optionsIcon.hide();
                    closeIcon.show();
                } else {
                    const noRecordsMessage = $('<p class="no-records">Nenhum registro encontrado para esse paciente.</p>');
                    resultsAll.append(noRecordsMessage);
                }
            }

            function setupLoadMoreButton(query) {
                const loadMoreButton = $('#load-more');
                const loadingIndicator = $('.loading');

                loadMoreButton.click(function () {
                    if (!loading) {
                        loading = true;
                        loadMoreButton.hide();
                        loadingIndicator.show();

                        fetchRecords(query, ++page);

                        loading = false;
                        loadingIndicator.hide();
                        loadMoreButton.show();
                    }
                });
            }

            function toggleFilterVisibility(isActive) {
                if (isActive) {
                    optionsIcon.hide();
                    closeIcon.show();
                } else {
                    optionsIcon.show();
                    closeIcon.hide();
                }
            }

            function createRecordHTML(record) {
            return `
                <div class="medical_record p-4 my-2 border rounded-lg">
                    <div class="title_tags">
                        <a class="title_medical_record" href="/path/to/view_single_medical_record/${record.id}">${record.name}</a>
                        <h5 class="medical_record-occupation">${record.created_at}</h5>
                    </div>
                    <div class="right_info">
                        <div class="medical_record_code">${record.record_type}</div>
                        <a class="view-icon" href="{% url 'view_single_medical_record' ${record.id} %}">
                            <div class="view">
                                <ion-icon name="eye-outline" role="img" class="md hydrated"></ion-icon>
                            </div>
                        </a>
                    </div>
                </div>
            `;
        }


            form.on('submit', handleFormSubmit);
        });
    </script>
{% endblock %}