{% extends 'base.html' %}
{% load static %}

{% block title %}Sem B.O{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'front/detail_style.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
{% include 'parciais/menu.html' %}
<div class="flex flex-col md:mt-12 items-center justify-center text-gray-800 pb-28 px-4">
  <div class="w-full bg-white px-4 md:px-6 rounded-xl">
    <div class="info px-4">
      <div class="procedure-header h-40 flex flex-col justify-center bg-black text-white p-6 rounded-xl">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="text-center md:text-left">
            <h1 class="text-2xl font-bold">{{ procedure.name }}</h1>
            <p class="text-sm text-gray-300 mt-1">Código do procedimento:</p>
            <div class="text-lg font-mono bg-white text-black inline-block mt-1 px-3 py-1 rounded cursor-pointer w-40 text-center" onclick="copyText()" id="code">{{ procedure.procedure_code }}</div>
          </div>
          <div class="flex flex-wrap justify-center md:justify-end gap-2 self-end items-center">
            {% for occupation in procedure.related_occupations_names %}
              <span class="bg-gray-800 text-white px-3 py-1 rounded text-sm">{{ occupation }}</span>
            {% endfor %}

            <button id="btn-favorite" title="Salvar favorito" aria-label="Salvar favorito" class="focus:outline-none">
              {% if favorite %}
                <i class="fa-solid fa-bookmark text-white text-2xl"></i>
              {% else %}
                <i class="fa-regular fa-bookmark text-white text-2xl"></i>
              {% endif %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="description bg-white px-6 py-4 rounded-lg">
      <div class="space-y-4">
        {% for record_name in procedure.get_records_names %}
          {% if record_name == 'BPA (Consolidado)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">BPA (Consolidado)</summary>
            <p class="text-sm mt-2">Procedimentos BPA (Consolidado) <b>devem ser realizados no ambulatório</b></p>
            <p class="text-sm mt-2">O BPA (Boletim de Produção Ambulatorial) consolidado é um documento que reúne informações sobre os procedimentos realizados no âmbito ambulatorial, fornecendo uma visão geral das atividades médicas e de saúde realizadas em determinado período.</p>
          </details>
          {% elif record_name == 'BPA (Individualizado)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">BPA (Individualizado)</summary>
            <p class="text-sm mt-2">Procedimentos BPA (Individualizado) <b>devem ser realizados no ambulatório</b></p>
            <p class="text-sm mt-2">O BPA individualizado é um documento que detalha os procedimentos realizados por um paciente específico, fornecendo um registro detalhado dos serviços prestados.</p>
          </details>
          {% elif record_name == 'AIH (Proc. Especial)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">AIH (Procedimento Especial)</summary>
            <p class="text-sm mt-2">Procedimentos AIH (Procedimento Especial) <b>devem ser realizados durante a internação</b></p>
            <p class="text-sm mt-2">A AIH de procedimento especial é um documento que registra procedimentos realizados durante internações complexas.</p>
          </details>
          {% elif record_name == 'AIH (Proc. Secundário)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">AIH (Procedimento Secundário)</summary>
            <p class="text-sm mt-2">Procedimentos AIH (Procedimento Secundário) <b>devem ser realizados durante a internação</b></p>
            <p class="text-sm mt-2">A AIH secundária é um documento que registra procedimentos médicos adicionais realizados durante internações hospitalares.</p>
          </details>
          {% elif record_name == 'AIH (Proc. Principal)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">AIH (Procedimento Principal)</summary>
            <p class="text-sm mt-2">Preencher na folha de internação/B.O cirúrgico/Resumo de Alta</p>
            <p class="text-sm mt-2">A AIH principal é um documento que registra o procedimento médico principal realizado durante internações hospitalares.</p>
          </details>
          {% elif record_name == 'APAC (Proc. Principal)' %}
          <details class="bg-gray-50 border rounded p-4">
            <summary class="font-semibold cursor-pointer">APAC (Procedimento Principal)</summary>
            <p class="text-sm mt-2">Formulário próprio de APAC</p>
            <p class="text-sm mt-2">O APAC de procedimento principal é um registro para pacientes que requerem cuidados de alta complexidade.</p>
          </details>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Espaço extra para evitar sobreposição com o menu -->
    <div class="h-[10rem]"></div>

    <div class="content-principal folder-modal">
      <div id="favorite-modal" class="modal hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-content-folder bg-gray-100 w-11/12 md:w-2/3 lg:w-1/3 mx-auto mt-10 rounded-lg p-6">
          <div class="sup-folder flex justify-between items-center">
            <div></div>
            <h2 class="text-xl ml-2 mb-2 title-modal-folders">Adicione a uma <b>Pasta de Favoritos</b></h2>
            <span class="close text-gray-600 cursor-pointer">&times;</span>
          </div>
          <ul class="mb-4">
            {% for folder in favorite_folders %}
            <li class="folder mb-2">
              <label for="folder-{{ folder.id }}" class="label-folder cursor-pointer list-folders flex justify-between items-center">
                <label for="folder-{{ folder.id }}">{{ folder.name }}</label>
                <input type="checkbox" id="folder-{{ folder.id }}" name="folders" value="{{ folder.id }}" class="checkbox-custom mr-2" {% if folder.name == 'Geral' %}checked{% endif %}>
              </label>
            </li>
            {% endfor %}
          </ul>
          <button id="confirm-favorite" class="bg-black text-white w-full py-2 px-4 rounded-md">Confirmar</button>
        </div>
      </div>
      <div class="blur hidden"></div>
    </div>

    {% include 'parciais/menu_inferior.html' %}
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Copiar texto do código do procedimento
  function copyText() {
    const codeElem = document.getElementById('code');
    const text = codeElem.innerText || codeElem.textContent;
    navigator.clipboard.writeText(text).then(() => {
      alert('Código copiado: ' + text);
    }).catch(() => {
      alert('Falha ao copiar o código.');
    });
  }

  $(document).ready(function() {
    // Toggle modal e ações de fechar
    const modal = $('#favorite-modal');
    const blur = $('.blur');
    const btnFavorite = $('#btn-favorite');
    const icon = btnFavorite.find('i');

    // Ao clicar no ícone bookmark, abre modal para escolher pasta
    btnFavorite.on('click', function() {
      modal.removeClass('hidden');
      blur.removeClass('hidden');
    });

    // Fechar modal ao clicar no X ou fora
    $('.close, .blur').on('click', function() {
      modal.addClass('hidden');
      blur.addClass('hidden');
    });

    // Confirmar adição/remover favorito
    $('#confirm-favorite').on('click', function() {
      // Pega as pastas selecionadas
      let selectedFolders = [];
      $('input[name="folders"]:checked').each(function() {
        selectedFolders.push($(this).val());
      });

      $.ajax({
        url: "{% url 'add_remove_favorite' %}",
        method: 'POST',
        data: {
          procedure_id: "{{ procedure.procedure_code }}",
          folders: selectedFolders,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          if(response.is_favorite) {
            icon.removeClass('fa-regular text-white').addClass('fa-solid text-white');
          } else {
            icon.removeClass('fa-solid text-white').addClass('fa-regular text-white');
          }
          modal.addClass('hidden');
          blur.addClass('hidden');
        },
        error: function() {
          alert('Erro ao salvar favorito');
        }
      });
    });
  });
</script>
{% endblock %}
