{% extends '_base.html' %}
{%  load static %}

{% block content %}
    <form method="GET" action="{% url 'search' %}">
        <div class="flex">
            <div class="search flex items-center bg-transparent pt-2 pb-2 w-full">
                <div class='mr-2 w-full'>
                    <input type="text" name="q"
                        class="block rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2 bg-[#F2F2F7] w-full"
                        placeholder="Digite o procedimento">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" id="open-filter-modal" aria-label="filter"
                        class="flex items-center justify-center rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition">
                        <ion-icon name="options-outline" class="w-6 h-6"></ion-icon>
                    </button>
                    <button type="submit" aria-label="search" 
                        class="flex items-center justify-center rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2.5 sm:py-2 bg-[#F2F2F7] hover:bg-gray-200 transition">
                        <ion-icon name="search-outline" class="w-5 h-5"></ion-icon>
                    </button>
                </div>                
            </div>
        </div>
    </form>    
    
    <div class="results">
        {% for procedure in procedures %}
            <div class="procedure p-4 my-2 border rounded-lg">
                <div class="title_tags">
                    <a class="title_procedure">{{ procedure }}</a>
                    <div class="records_tags hidden md:flex">
                        {% for occupation in procedure.related_occupations_names %}
                            <a class="procedure-occupation" href="#">{{ occupation }}</a>
                        {% endfor %}
                        {% for record in procedure.get_records_names %}
                            <a href="#">{{ record }}</a>
                        {% endfor %}
                    </div>
                </div>
                <div class="right_info">
                    {% if procedure.procedure_code in favorite %}
                        <ion-icon name="bookmark" class="w-5 h-5 md hydrated favorite-icon" data-procedure-id="{{ procedure.procedure_code }}" role="img"></ion-icon>
                    {% else %}
                        <ion-icon name="bookmark-outline" class="w-5 h-5 md hydrated favorite-icon" data-procedure-id="{{ procedure.procedure_code }}" role="img"></ion-icon>
                    {% endif %}
                    <div class="procedure_code">{{ procedure.procedure_code }}</div>
                    <a class="help-icon" href="{% url 'procedure_detail' procedure_code=procedure.procedure_code %}">
                        <div class="help">
                            <ion-icon name="help-circle-outline" role="img" class="md hydrated"></ion-icon>
                        </div>
                    </a>
                </div>
            </div>
        {% endfor %}
        <button id="load-more" style="display: {% if procedures.has_next %}block{% else %}none{% endif %};">Carregar Mais</button>
        <div class="loading" style="display: none;">carregando...</div>
    </div>
    
    <div class="content-principal">
        <div class="modal-content bg-gray-100 w-11/12 md:w-2/3 lg:w-1/3 mx-auto mt-10 rounded-lg p-6 hidden">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-700">Filtros</h2>
                <span class="close text-2xl cursor-pointer" id="close-modal">&times;</span>
            </div>
        
            <div class="mt-2">
                <label for="record-name-filter" class="text-gray-600">Nome de Registros</label>
                <select id="record-name-filter" class="block w-full px-4 py-2 mt-1 border rounded-lg bg-gray-200 focus:outline-none filter-results">
                    <option value="all">Todos</option>
                    {% for record in records %}
                        <option value="{{ record.name }}">{{ record.name }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <div class="mt-4">
                <button id="apply-filter" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg">Aplicar</button>
            </div>
        </div>
        <div class="blur hidden"></div>
    </div>
    
    <div class="content-principal folder-modal">
        <div id="favorite-modal" class="modal hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
            <div class="modal-content-folder bg-gray-100 w-11/12 md:w-2/3 lg:w-1/3 mx-auto mt-10 rounded-lg p-6">
                <div class="sup-folder">
                    <div></div>
                    <h2 class="text-xl ml-2 mb-2 title-modal-folders">Adicione a uma <b>pasta de Favoritos</b></h2>
                    <span class="close text-gray-600 cursor-pointer">&times;</span>
                </div>
                <ul class="mb-4">
                    {% for folder in favorite_folders %}
                    <li class="folder mb-2">
                        <label for="folder-{{ folder.id }}" class="label-folder cursor-pointer list-folders">
                            <label for="folder-{{ folder.id }}">{{ folder.name }}</label>
                            <input type="checkbox" id="folder-{{ folder.id }}" name="folders" value="{{ folder.id }}" class="checkbox-custom mr-2" {% if folder.name == 'Geral' %}checked{% endif %}>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <button id="confirm-favorite" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
        <div class="blur hidden"></div>
    </div>

    <script>
        $(document).ready(function () {
          $('#open-filter-modal').on('click', function () {
            Swal.fire({
              title: 'Filtro',
              html: `
                <select id="record-name-filter" class="select2 w-full bg-gray-200 rounded-lg px-2 py-2 mb-4">
                    <option value="all">Todos</option>
                    <option value="BPA (Consolidado)">BPA (Consolidado)</option>
                    <option value="BPA (Individualizado)">BPA (Individualizado)</option>
                    <option value="AIH (Proc. Principal)">AIH (Proc. Principal)</option>
                    <option value="AIH (Proc. Especial)">AIH (Proc. Especial)</option>
                    <option value="AIH (Proc. Secundário)">AIH (Proc. Secundário)</option>
                    <option value="APAC (Proc. Principal)">APAC (Proc. Principal)</option>
                    <option value="APAC (Proc. Secundário)">APAC (Proc. Secundário)</option>
                    <option value="RAAS (Atenção Domiciliar)">RAAS (Atenção Domiciliar)</option>
                    <option value="RAAS (Atenção Psicossocial)">RAAS (Atenção Psicossocial)</option>
                    <option value="e-SUS APS (Atenção Primária à Saúde)">e-SUS APS (Atenção Primária à Saúde)</option>
                </select>
      
                <!-- Botão preto para aplicar -->
                <button type="button" id="apply-filter-btn"
                    class="relative w-full bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition my-2 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <span>Aplicar</span>
                    <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
              `,
              showConfirmButton: false,
              showCloseButton: true,
              width: '32rem',
              background: '#f3f4f6',
              didOpen: () => {
                // Ativa o Select2 no select dentro do modal
                $('.select2').select2({
                  dropdownParent: $('.swal2-popup')
                });
      
                // Ação do botão "Aplicar"
                $('#apply-filter-btn').on('click', function () {
                  const query = $('#search-query').val();
                  const filter = $('#record-name-filter').val();
      
                  // Exibe o spinner
                  $(this).find('.spinner').removeClass('hidden');
      
                  console.log('Buscar:', query);
                  console.log('Filtro selecionado:', filter);
      
                  // Aqui você pode enviar via AJAX ou redirecionar
                  // Exemplo: simular um carregamento
                  setTimeout(() => {
                    Swal.close();
                  }, 1000);
                });
              }
            });
          });
        });
      </script>
      
{% endblock %}