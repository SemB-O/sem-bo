{% extends 'base_auth.html' %}
{%  load static %}
{% block title %}
Sem B.O
{% endblock %}
{% block head %}
<link rel="stylesheet" href="{% static 'front/register_style.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.15.2/css/selectize.default.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
   $(document).ready(function () {
       $('select.select2').select2({
           width: '100%',
           placeholder: 'Selecione suas ocupações',
           allowClear: true,
           closeOnSelect: false, // Mantém aberto para múltiplas seleções
           language: {
               noResults: function() {
                   return "Nenhuma ocupação encontrada";
               },
               searching: function() {
                   return "Buscando...";
               }
           }
       });
       
       // Limpa o texto de pesquisa após selecionar um item
       $('select.select2').on('select2:select', function(e) {
           const $selection = $(this).next('.select2-container').find('.select2-selection--multiple');
           
           // Limpa o campo de busca
           const $searchField = $selection.find('.select2-search__field');
           setTimeout(() => {
               $searchField.val('');
           }, 10);
           
           // Animação
           $selection.addClass('pulse-animation');
           setTimeout(() => {
               $selection.removeClass('pulse-animation');
           }, 300);
       });
       
       // Animação ao remover
       $('select.select2').on('select2:unselect', function(e) {
           const $selection = $(this).next('.select2-container').find('.select2-selection--multiple');
           $selection.addClass('pulse-animation');
           setTimeout(() => {
               $selection.removeClass('pulse-animation');
           }, 300);
       });
   });      
</script>
{% endblock %}
{% block content %}
<style>
   .select2-container .select2-selection--single,
   .select2-container .select2-selection--multiple {
       margin-top: 0.25rem;
       display: flex;
       align-items: center;
       width: 100%;
       border-radius: 0.375rem;
       border: 1px solid #d1d5db;
       box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
       font-size: 0.875rem;
       transition: border-color 0.2s, box-shadow 0.2s;
       background-color: #F2F2F7 !important;
       min-height: 2.25rem;
       padding: 0.25rem 0.5rem;
       box-sizing: border-box;
   }
   
   .select2-container--focus .select2-selection {
       border-color: black !important;
       box-shadow: 0 0 0 1px black;
   }
   
   /* Estilização das tags/badges selecionadas */
   .select2-container--default .select2-selection--multiple .select2-selection__choice {
       background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%) !important;
       border: none !important;
       border-radius: 0.5rem !important;
       padding: 0.375rem 0.75rem !important;
       margin: 0.125rem !important;
       color: white !important;
       font-size: 0.875rem !important;
       font-weight: 500 !important;
       display: inline-flex !important;
       align-items: center !important;
       gap: 0.5rem !important;
       box-shadow: 0 2px 4px rgba(6, 182, 212, 0.3) !important;
       transition: all 0.2s ease !important;
   }
   
   .select2-container--default .select2-selection--multiple .select2-selection__choice:hover {
       background: linear-gradient(135deg, #0891b2 0%, #2563eb 100%) !important;
       box-shadow: 0 4px 6px rgba(6, 182, 212, 0.4) !important;
       transform: translateY(-1px) !important;
   }
   
   /* Botão de remover (X) dentro da tag */
   .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
       color: white !important;
       font-size: 1.125rem !important;
       font-weight: bold !important;
       margin-right: 0 !important;
       margin-left: 0 !important;
       border: none !important;
       opacity: 0.8 !important;
       transition: opacity 0.2s ease !important;
       cursor: pointer !important;
       order: 2 !important;
   }
   
   .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
       background: transparent !important;
       opacity: 1 !important;
       color: #fee2e2 !important;
   }
   
   /* Botão "X" para limpar tudo - posicionado à direita */
   .select2-container--default .select2-selection--multiple .select2-selection__clear {
       position: absolute !important;
       right: 0.75rem !important;
       top: 50% !important;
       transform: translateY(-50%) !important;
       width: 1.5rem !important;
       height: 1.5rem !important;
       display: flex !important;
       align-items: center !important;
       justify-content: center !important;
       background: rgba(156, 163, 175, 0.5) !important; /* Cinza mais discreto e transparente */
       border-radius: 50% !important;
       color: white !important;
       font-size: 0.875rem !important; /* Tamanho do X reduzido */
       font-weight: bold !important;
       line-height: 1.5rem !important; /* Centraliza verticalmente */
       cursor: pointer !important;
       z-index: 10 !important;
       transition: all 0.2s ease !important;
       opacity: 0.7 !important; /* Mais discreto */
       padding: 0 !important;
       margin: 0 !important;
       text-align: center !important;
   }
   
   .select2-container--default .select2-selection--multiple .select2-selection__clear:hover {
       background: rgba(107, 114, 128, 0.8) !important; /* Cinza mais escuro no hover */
       opacity: 1 !important;
       transform: translateY(-50%) scale(1.05) !important; /* Scale mais sutil */
   }
   
   /* Ajusta o container para dar espaço ao botão de limpar */
   .select2-container--default.select2-container--focus .select2-selection--multiple {
       position: relative !important;
       padding-right: 3rem !important;
   }
   
   .select2-container--default .select2-selection--multiple {
       position: relative !important;
       padding-right: 3rem !important;
   }
   
   /* Input de busca dentro do multiselect */
   .select2-container--default .select2-search--inline .select2-search__field {
       margin-top: 0 !important;
       padding: 0.25rem !important;
       font-size: 0.875rem !important;
       color: #374151 !important;
   }
   
   .select2-container--default .select2-search--inline .select2-search__field::placeholder {
       color: #9CA3AF !important;
       opacity: 1 !important;
   }
   
   /* Container dos itens selecionados */
   .select2-container--default .select2-selection--multiple .select2-selection__rendered {
       display: flex !important;
       flex-wrap: wrap !important;
       gap: 0.25rem !important;
       padding: 0 !important;
       padding-right: 0 !important;
       width: 100% !important;
       box-sizing: border-box !important;
   }
   
   /* Garante que os itens não quebrem quando o botão X aparece */
   .select2-container--default .select2-selection--multiple .select2-selection__rendered li {
       max-width: calc(100% - 3rem) !important;
   }
   
   /* Dropdown de opções */
   .select2-container--default .select2-results__option--highlighted[aria-selected] {
       background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%) !important;
       color: white !important;
   }
   
   .select2-container--default .select2-results__option[aria-selected=true] {
       background-color: #dbeafe !important;
       color: #1e40af !important;
   }
   
   /* Animação suave ao adicionar/remover */
   .select2-container--default .select2-selection--multiple .select2-selection__choice {
       animation: slideIn 0.2s ease-out;
   }
   
   @keyframes slideIn {
       from {
           opacity: 0;
           transform: scale(0.8);
       }
       to {
           opacity: 1;
           transform: scale(1);
       }
   }
   
   /* Animação de pulse no container */
   .pulse-animation {
       animation: pulse 0.3s ease-out;
   }
   
   @keyframes pulse {
       0%, 100% {
           transform: scale(1);
       }
       50% {
           transform: scale(1.02);
       }
   }
   
   /* Scroll suave no dropdown */
   .select2-results__options {
       max-height: 250px !important;
       overflow-y: auto !important;
   }
   
   .select2-results__options::-webkit-scrollbar {
       width: 8px;
   }
   
   .select2-results__options::-webkit-scrollbar-track {
       background: #f1f5f9;
       border-radius: 10px;
   }
   
   .select2-results__options::-webkit-scrollbar-thumb {
       background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 100%);
       border-radius: 10px;
   }
   
   .select2-results__options::-webkit-scrollbar-thumb:hover {
       background: linear-gradient(180deg, #0891b2 0%, #2563eb 100%);
   }
</style>
<section class="m-0 h-screen text-black bg-white box-border grid grid-rows-[1fr_2fr_1fr] justify-items-center py-6 md:py-0 w-full">
   <div></div>
   <div class="flex flex-col gap-2 justify-center items-center px-6 md:px-0 w-full md:w-2/3">
      <div class="sticky text-center py-2">
         <h1 class="font-bold text-6xl md:text-7xl">Hora do <span class="text-[#43D1EB]">cadastro</span></h1>
         <p class="text-gray-600 break-all">Preencha o formulário com suas informações!</p>
      </div>
      <form id="onboarding-form" class="w-full max-w-md md:max-w-xl md:px-0 px-4 mx-auto flex flex-col gap-4" action="{% url 'register' selected_plan=selected_plan %}" method="post">
         {% csrf_token %}
         <div class="step flex flex-col gap-4" id="step-1">
            <div class="text-left hidden md:block">
               <h1 class="font-bold text-3xl md:text-4xl">Passo 1:</h1>
               <p class="text-gray-600">Suas informações pessoais!</p>
            </div>
            <div>
               {{ form.first_name.as_field_group }}
            </div>
            <div>
               {{ form.last_name.as_field_group }}
            </div>
            <div>
               {{ form.CPF.as_field_group }}
            </div>
            <div>
               {{ form.telephone.as_field_group }}
            </div>
            <div>
               {{ form.date_of_birth.as_field_group }}
            </div>
            <div class="flex gap-2 my-2">
                <a href="{% url 'select_plan' %}"
                    class="relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition my-2 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <span>Anterior</span>
                    <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </a>
                <button type="button" id="first-step"
                class="next-step relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition my-2 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                <span>Próximo</span>
                <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
         </div>
         <div class="step flex flex-col gap-4" id="step-2" style="display: none;">
            <div class="text-left hidden md:block">
               <h1 class="font-bold text-3xl md:text-4xl">Passo 2:</h1>
               <p class="text-gray-600">Suas informações profissionais!</p>
            </div>
            <div>
               {{ form.occupational_registration.as_field_group }}
            </div>
            <div>
               {{ form.occupations.as_field_group }}
            </div>
            <div class="error-message text-sm text-red-600 hidden"></div>
            <div class="flex gap-2 my-2">
               <button type="button"
                  class="previous-step relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition my-2 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <span>Anterior</span>
                  <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
               </button>
               <button type="button" id="second-step"
                  class="next-step relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition my-2 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <span>Próximo</span>
                  <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
               </button>
            </div>
         </div>
         <div class="step flex flex-col gap-4" id="step-3" style="display: none;">
            <div class="text-left hidden md:block">
               <h1 class="font-bold text-3xl md:text-4xl">Passo 3:</h1>
               <p class="text-gray-600">Suas informações de login!</p>
            </div>
            <div>
               {{ form.email.as_field_group }}
            </div>
            <div>
               {{ form.password1.label_tag }}
               <div class="relative">
                  {{ form.password1 }}
                  <span class="material-symbols-outlined toggle-password absolute top-1/2 -translate-y-1/2 right-3 flex items-center cursor-pointer text-[#9CA4B1] text-[1.2rem] z-10">
                  visibility
                  </span>
               </div>
               <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
            </div>
            <div>
               {{ form.password2.label_tag }}
               <div class="relative">
                  {{ form.password2 }}
                  <span class="material-symbols-outlined toggle-password absolute top-1/2 -translate-y-1/2 right-3 flex items-center cursor-pointer text-[#9CA4B1] text-[1.2rem] z-10">
                  visibility
                  </span>
               </div>
               <div class="error-message text-sm text-red-600 mt-1 hidden"></div>
            </div>
            <div class="flex gap-2 my-2">
               <button type="button"
                  class="previous-step relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <span>Anterior</span>
                  <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
               </button>
               <button type="submit"
                  class="submit-form relative w-1/2 bg-[#0F0F0F] text-white py-2 px-4 rounded-lg transition disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <span>Cadastrar</span>
                  <div class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
               </button>
            </div>
         </div>
      </form>
   </div>
   <div class="flex justify-center py-8">
      <p>Já tem cadastro? <a href="{% url 'login' %}" class="text-blue-500">Faça login</a></p>
   </div>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
   $(document).ready(function() {
       function validateOccupations() {
           let selectedPlan = $('.plan-select option:selected').text();
           let occupations = $('.occupation-select').val();
           let OccupationError = $('#occupation-error');
   
           let maxOccupations = 0;
   
           if (selectedPlan === 'Plano Essencial') {
               maxOccupations = 1;
           } else if (selectedPlan === 'Plano Essencial +') {
               maxOccupations = 3;
           }
   
           if (occupations && occupations.length > maxOccupations) {
               OccupationError.text(`O ${selectedPlan} permite selecionar até ${maxOccupations} ocupação(ões).`).fadeIn();
               return false;
           } else {
               OccupationError.hide();
               return true;
           }
       }
   
       validateOccupations();
   
       $('.plan-select').on('change', function() {
           validateOccupations();
           $('.occupation-select').val(null).trigger('change');
       });
   
       $('.occupation-select').on('select2:select select2:unselect', function() {
           validateOccupations();
       });
   
       $('.occupation-select').on('change', function() {
           validateOccupations();
       });
   
       $('form').on('submit', function(e) {
           if (!validateOccupations()) {
               e.preventDefault();
           }
       });
   });
</script>
<script>
   $(document).ready(function(){
       $('#id_telephone').mask('(00) 00000-0000');
       $('#id_CPF').mask('000.000.000-00', {reverse: true});
       
       // Máscara de data no input alternativo do flatpickr
       const dateInput = document.querySelector('#id_date_of_birth');
       
       flatpickr("#id_date_of_birth", {
           dateFormat: "Y-m-d",
           altInput: true,
           altFormat: "d/m/Y",
           allowInput: true, // Permite digitação manual
           placeholder: "dd/mm/aaaa",
           onChange: function(selectedDates, dateStr, instance) {
               instance.element.value = dateStr;
           },
           onReady: function(selectedDates, dateStr, instance) {
               // Aplica máscara no input alternativo (visível)
               $(instance.altInput).mask('00/00/0000', {
                   placeholder: "dd/mm/aaaa",
                   onComplete: function(value) {
                       // Converte dd/mm/yyyy para yyyy-mm-dd
                       const parts = value.split('/');
                       if (parts.length === 3) {
                           const day = parts[0];
                           const month = parts[1];
                           const year = parts[2];
                           const isoDate = `${year}-${month}-${day}`;
                           
                           // Valida e define a data no flatpickr
                           const date = new Date(isoDate);
                           if (!isNaN(date.getTime())) {
                               instance.setDate(isoDate, true);
                           }
                       }
                   }
               });
           }
       });
   });
</script>
<script>
   $(document).ready(function () {
       $('#loadingOverlaySmart').hide();
   
       $('#save-button').on('submit', function () {
           $('#loadingOverlaySmart').show();
       });
   });
</script>
<script>
   class LoadingButtonHandler {
       static setLoading($button) {
           $button.prop('disabled', true);
           $button.find('.spinner').removeClass('hidden');
       }
   
       static unsetLoading($button) {
           $button.prop('disabled', false);
           $button.find('.spinner').addClass('hidden');
       }
   
       static toggleLoading($button, isLoading) {
           isLoading ? this.setLoading($button) : this.unsetLoading($button);
       }
   
       static toggleAllButtons(clickedButton, isLoading = true, scope = document) {
           const $scope = $(scope);
           const $clickedButton = $(clickedButton);
   
           console.log($scope, $clickedButton)
           const $allButtons = $scope.find('button');
           console.log($allButtons)
   
           $allButtons.each(function () {
               const $btn = $(this);
               if (!$btn.is($clickedButton)) {
                   $btn.prop('disabled', isLoading);
               }
           });
   
           LoadingButtonHandler.toggleLoading($clickedButton, isLoading);
       }
   }    
</script>
<script>
   class StepNavigator {
       static steps = $('.step');
   
       static showStep(stepIndex) {
           this.steps.hide();
           this.steps.eq(stepIndex).fadeIn();
       }
   
       static next($currentStep) {
           const currentIndex = this.steps.index($currentStep);
           const nextIndex = currentIndex + 1;
   
           if (nextIndex < this.steps.length) {
               this.showStep(nextIndex);
           }
       }
   
       static previous($currentStep) {
           const currentIndex = this.steps.index($currentStep);
           const prevIndex = currentIndex - 1;
   
           if (prevIndex >= 0) {
               this.showStep(prevIndex);
           }
       }
   
       static advanceStepIfValid(advanceStepIfValidButton, goNextStep = true) {
           const $step = $(advanceStepIfValidButton).closest('.step');
           const stepIndex = StepNavigator.steps.index($step);
           const stepNumber = stepIndex + 1;
       
           return OnboardingFormHandler.validateAndSaveStep(stepNumber, $step).then((isValid) => {
               if (isValid && goNextStep) {
                   StepNavigator.next($step);
               }
               return isValid;
           });
       }
   
       static setupListeners() {
           const $nextButtons = $(".next-step");
           const $previousButtons = $(".previous-step");
           const $submitButtons = $("button[type='submit']");
       
           $nextButtons.on("click", function (e) {
               e.preventDefault();
               LoadingButtonHandler.toggleAllButtons(this, true);
       
               StepNavigator.advanceStepIfValid(this).then(() => {
                   LoadingButtonHandler.toggleAllButtons(this, false);
               });
           });
       
           $previousButtons.on("click", function (e) {
               e.preventDefault();
               const $step = $(this).closest('.step');
               StepNavigator.previous($step);
           });
       
           $submitButtons.on("click", function (e) {
               e.preventDefault();
       
               const userNameRaw = $('#id_first_name').val() || 'Usuário';
               const userName = userNameRaw.trim().charAt(0).toUpperCase() + userNameRaw.trim().slice(1).toLowerCase();
               const userEmail = $('#id_email').val() || '';

               LoadingButtonHandler.toggleAllButtons(this, true);       
               StepNavigator.advanceStepIfValid(this, false).then((isValid) => {
                   LoadingButtonHandler.toggleAllButtons(this, false);
       
                   if (isValid) {
                       Swal.fire({
                           icon: 'success',
                           title: `Seja bem-vindo, ${userName}!`,
                           html: `
                               <p class="mb-2">Seu registro foi finalizado com sucesso!</p>
                               <p class="text-sm text-gray-600">
                                   Enviamos um email de verificação para <strong>${userEmail}</strong>. 
                                   Por favor, verifique sua caixa de entrada e clique no link para ativar sua conta.
                               </p>
                           `,
                           confirmButtonText: 'Entendi',
                           customClass: {
                               confirmButton: 'bg-black text-white hover:bg-gray-900 px-4 py-2 rounded',
                               popup: 'rounded-xl',
                           },
                           buttonsStyling: false
                       }).then((result) => {
                           if (result.isConfirmed) {
                               window.location.href = '/login';
                           }
                       });
                   }
               });
           });
       }
       
   }
   
   $(document).ready(function () {
       StepNavigator.setupListeners();
   });
</script>
<script>
   class OnboardingFormHandler {
   
       static getPlanIdFromUrl() {
           const match = window.location.pathname.match(/\/register\/(\d+)\//);
           return match ? match[1] : null;
       }
   
       static apiUrls = {
           1: "{% url 'onboarding-user-validate-personal-info' %}",
           2: "{% url 'onboarding-user-validate-professional-info' %}",
           3: "{% url 'onboarding-user-create' %}",
       };
   
       static fieldMapByStep = {
           1: {
               first_name: () => $('#id_first_name'),
               last_name: () => $('#id_last_name'),
               CPF: () => $('#id_CPF'),
               telephone: () => $('#id_telephone'),
               date_of_birth: () => {
                   const $hiddenInput = $('#id_date_of_birth');
                   const value = $hiddenInput.val();
   
                   return $hiddenInput.parent().find('input:not([type="hidden"])');
               },
           },
           2: {
               selected_plan: () => {
                   const value = OnboardingFormHandler.getPlanIdFromUrl();
                   return $('<input>').val(value); 
               },
               occupational_registration: () => $('#id_occupational_registration'),
               occupations: () => $('#occupation-select'),
           },
           3: {
               email: () => $('#id_email'),
               password1: () => $('#id_password1'),
               password2: () => $('#id_password2'),
           }
       };
   
       static getStepData(stepNumber) {
           const fields = this.fieldMapByStep[stepNumber];
           const data = {};
   
           for (const [key, getElement] of Object.entries(fields)) {
               data[key] = getElement().val();
           }
   
           return data;
       }
   
       static clearErrors($step, stepNumber) {
           $step.find('.error-message').addClass('hidden').text('');
           const fields = this.fieldMapByStep[stepNumber];
   
           for (const getElement of Object.values(fields)) {
               getElement().removeClass('border-red-500 bg-red-50')
                           .addClass('border-gray-300');
           }
       }
   
       static showErrors($step, stepNumber, errors) {
           const fields = this.fieldMapByStep[stepNumber];
   
           for (const [field, messages] of Object.entries(errors)) {
               const getElement = fields[field];
               if (!getElement) continue;
   
               const $field = getElement();
               $field.removeClass('border-gray-300')
                     .addClass('border-red-500 bg-red-50');
   
               // Para campos de senha, busca o container pai (que contém label + div relativo + error)
               let $container;
               if (field === 'password1' || field === 'password2') {
                   $container = $field.closest('div').parent(); // Sobe um nível extra
               } else {
                   $container = $field.closest('div');
               }
               
               let $error = $container.find('.error-message').first();
   
               if (!$error.length) {
                   $error = $('<div class="error-message text-sm text-red-600 mt-1"></div>').appendTo($container);
               }
   
               $error.text(messages.join(', ')).removeClass('hidden');
           }
       }
   
       static validateAndSaveStep(stepNumber, $step) {
           const isLastStep = stepNumber === Math.max(...Object.keys(this.fieldMapByStep).map(Number));
           const url = this.apiUrls[stepNumber];
       
           const data = isLastStep
           ? Object.assign({}, ...Object.keys(this.fieldMapByStep).map(step => this.getStepData(Number(step))))
           : this.getStepData(stepNumber);
   
           this.clearErrors($step, stepNumber);
       
            return new Promise((resolve) => {
                $.ajax({
                    url: url,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        resolve(true);
                    },
                    error: (xhr) => {
                        const response = xhr.responseJSON;
            
                        if (response && response.errors) {
                            OnboardingFormHandler.showErrors($step, stepNumber, response.errors);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro inesperado',
                                text: 'Ocorreu um erro ao validar os dados. Tente novamente.',
                                confirmButtonText: 'Ok',
                                customClass: {
                                    confirmButton: 'bg-black text-white hover:bg-gray-900 px-4 py-2 rounded',
                                    popup: 'rounded-xl',
                                },
                                buttonsStyling: false
                            });
                        }
            
                        resolve(false);
                    }
                });
            });
       }
   }
</script>
{% endblock %}