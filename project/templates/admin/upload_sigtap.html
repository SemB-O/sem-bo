{% extends 'admin/base_admin.html' %}

{% block page_title %}Upload SIGTAP{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <div class="bg-white rounded-xl shadow-sm p-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Upload de Arquivos SIGTAP</h2>
            <p class="text-gray-600">Faça o upload dos arquivos .txt da base de dados SIGTAP</p>
        </div>
        
        <!-- Upload Form -->
        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    Selecione os arquivos SIGTAP (.txt)
                </label>
                
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary transition cursor-pointer" id="dropZone">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-300 mb-4"></i>
                    <p class="text-lg font-medium text-gray-700 mb-2">Arraste arquivos aqui ou clique para selecionar</p>
                    <p class="text-sm text-gray-500 mb-4">Suporta múltiplos arquivos .txt</p>
                    <input type="file" name="arquivos_txt" id="fileInput" multiple accept=".txt" class="hidden">
                    <button type="button" onclick="document.getElementById('fileInput').click()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-medium">
                        <i class="fas fa-folder-open mr-2"></i>
                        Selecionar Arquivos
                    </button>
                </div>
                
                <!-- Selected Files -->
                <div id="selectedFiles" class="mt-4 space-y-2 hidden"></div>
            </div>
            
            <!-- File Types Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                <h3 class="font-semibold text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Tipos de arquivos suportados:
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-800">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">tb_procedimento</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">tb_ocupacao</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">tb_registro</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">tb_cid</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">rl_procedimento_cid</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">rl_procedimento_ocupacao</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">rl_procedimento_registro</code>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        <code class="bg-white px-2 py-1 rounded">tb_descricao</code>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="flex items-center justify-end space-x-4">
                <button type="submit" id="submitBtn" disabled class="px-8 py-3 bg-gradient-to-r from-cyan-400 to-blue-400 text-white rounded-lg hover:from-cyan-500 hover:to-blue-500 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>
                    Iniciar Upload
                </button>
            </div>
        </form>
    </div>
    
    <!-- Progress Modal (initially hidden) -->
    <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-spinner fa-spin text-6xl text-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Processando arquivos...</h3>
                <p class="text-gray-600 mb-4">Por favor, aguarde. Isso pode levar alguns minutos.</p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-cyan-400 to-blue-400 h-2 rounded-full animate-pulse" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const selectedFiles = document.getElementById('selectedFiles');
const submitBtn = document.getElementById('submitBtn');
const uploadForm = document.getElementById('uploadForm');
const progressModal = document.getElementById('progressModal');

// Drag and drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary', 'bg-cyan-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-primary', 'bg-cyan-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-cyan-50');
    const files = e.dataTransfer.files;
    fileInput.files = files;
    displayFiles(files);
});

// File selection
fileInput.addEventListener('change', (e) => {
    displayFiles(e.target.files);
});

function displayFiles(files) {
    selectedFiles.innerHTML = '';
    selectedFiles.classList.remove('hidden');
    
    if (files.length === 0) {
        selectedFiles.classList.add('hidden');
        submitBtn.disabled = true;
        return;
    }
    
    Array.from(files).forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'flex items-center justify-between bg-gray-50 rounded-lg p-3';
        fileDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-file-alt text-primary mr-3"></i>
                <div>
                    <p class="font-medium text-gray-900">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(2)} KB</p>
                </div>
            </div>
            <i class="fas fa-check-circle text-green-500"></i>
        `;
        selectedFiles.appendChild(fileDiv);
    });
    
    submitBtn.disabled = false;
}

// Form submission
uploadForm.addEventListener('submit', (e) => {
    progressModal.classList.remove('hidden');
});
</script>
{% endblock %}
